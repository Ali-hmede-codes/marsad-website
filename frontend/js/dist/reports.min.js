(()=>{let t=[],e=[];function n(t,e=500,n=!0){let o;return function(){const a=this,r=arguments,i=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||t.apply(a,r)},e),i&&t.apply(a,r)}}async function o(e=""){try{let n=`${window.API_URL}/reports/today`;e&&(n+=`?category=${e}`);const o=await fetch(n);if(!o.ok){const t=await o.json().catch(()=>({}));throw new Error(t.error||"فشل تحميل التقارير")}const a=await o.json();if(t=Array.isArray(a)?a:[],window.updateMapMarkers)try{window.updateMapMarkers(t)}catch(t){window.showNotification&&window.showNotification("حدث خطأ في عرض العلامات","error")}const r=document.getElementById("dailyDate");return c(r?r.value:i(new Date)),t}catch(t){return console.error("Error loading reports:",t),navigator.onLine?window.showNotification&&window.showNotification(t.message||"فشل تحميل التقارير","error"):window.showNotification&&window.showNotification("لا يوجد اتصال بالشبكة","error"),[]}}function a(t){const n=e.find(e=>e.catg_id==t);return n?n.catg_name:"غير معروف"}function r(t){if(!t)return"";const e=t.split(",");return e[0]?e[0].trim():t}function i(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function c(e){const n=document.querySelector("#dailyReportsTable tbody");n&&(n.innerHTML="",t.filter(t=>i(new Date(t.date_and_time))===e).forEach(t=>{const e=document.createElement("tr"),o=new Date(t.date_and_time).toLocaleTimeString("ar-LB",{hour:"2-digit",minute:"2-digit"}),i=t.category_name||a(t.categorie),c=r(t.report_address);e.innerHTML=`<td>${o}</td><td><span style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>                <circle cx="12" cy="9" r="2" fill="currentColor"></circle>            </svg> ${i}</span></td><td>${c}</td>`,n.appendChild(e)}))}async function d(t){const e=document.getElementById("categoryFilter"),n=e?e.value:"",a=document.getElementById("refreshBtn"),r=document.getElementById("refreshDailyBtn");if(window.setMapLoading&&window.setMapLoading(!0),a){a.disabled=!0;const t=a.innerHTML;a.dataset.prev=t,a.innerHTML='<span class="loading" style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <circle cx="12" cy="12" r="10" opacity="0.2"></circle>                <path d="M12 2a10 10 0 0 1 10 10" />            </svg>            جاري التحديث...        </span>'}r&&(r.disabled=!0);try{window.clearMarkers&&window.clearMarkers(),await o(n),window.showNotification&&window.showNotification(t?"تم تحديث تقارير اليوم لليوم الجديد":"تم تحديث تقارير اليوم","info")}catch(t){window.showNotification&&window.showNotification("حدث خطأ أثناء التحديث","error")}finally{a&&(a.disabled=!1,a.dataset.prev&&(a.innerHTML=a.dataset.prev)),r&&(r.disabled=!1),window.setMapLoading&&window.setMapLoading(!1)}}function l(t,e){if(!t)return null;const n=String(t).trim().replace(/\s+/g," ");let o=1;const a=n.match(/[NSEW]/i);if(a){const t=a[0].toUpperCase();"S"!==t&&"W"!==t||(o=-1)}const r=n.replace(/°/g," ").replace(/'/g," ").replace(/"/g," ").trim().split(" ").filter(Boolean);let i=0,c=0,d=0;if(1===r.length){const t=parseFloat(r[0]);return isNaN(t)?null:t*o}if(2===r.length){if(i=parseFloat(r[0]),c=parseFloat(r[1]),isNaN(i)||isNaN(c))return null}else if(i=parseFloat(r[0]),c=parseFloat(r[1]),d=parseFloat(r[2]),isNaN(i)||isNaN(c)||isNaN(d))return null;const l=(Math.abs(i)+Math.abs(c)/60+Math.abs(d)/3600)*(i<0?-1:1)*o;return e&&Math.abs(l)>180||!e&&Math.abs(l)>90?null:l}window.showReportDetails=function(t){const e=document.getElementById("detailsModal"),n=document.getElementById("reportDetails");if(!e||!n)return;const o=new Date(t.date_and_time).toLocaleDateString("ar-LB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),r=t.category_name||a(t.categorie),i=`rgb(${t.category_color_r||100}, ${t.category_color_g||100}, ${t.category_color_b||100})`;n.innerHTML=`\n        <div class="report-detail">\n            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">\n                <div style="\n                    background-color: ${i};\n                    width: 48px;\n                    height: 48px;\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 28px;\n                    border: 3px solid white;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n                ">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n                        <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>\n                        <circle cx="12" cy="9" r="2" fill="white"></circle>\n                    </svg>\n                </div>\n                <h3 style="margin: 0; color: ${i};">${r}</h3>\n            </div>\n            <p><strong>الموقع:</strong> ${t.report_address}</p>\n            <p><strong>التاريخ والوقت:</strong> ${o}</p>\n            <p><strong>الإحداثيات:</strong> ${t.latitude.toFixed(6)}, ${t.longitude.toFixed(6)}</p>\n            ${t.reporter_name?`<p><strong>المبلغ:</strong> ${t.reporter_name}</p>`:""}\n        </div>\n    `,e.classList.add("active")},document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("dailyDate");if(t){const e=i(new Date);t.value=e,t.addEventListener("change",()=>c(t.value)),c(e)}}),document.addEventListener("DOMContentLoaded",()=>{!async function(){try{const t=await fetch(`${window.API_URL}/categories`),n=await t.json();e=n;const a=document.getElementById("categoryFilter"),r=document.getElementById("reportCategory");a&&(a.innerHTML='<option value="">جميع الفئات</option>',n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),a.appendChild(e)}}));const i=document.getElementById("mainCategoryFilter");if(i){i.innerHTML='<option value="">جميع الفئات الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,i.appendChild(e)});const t=t=>{if(!a)return;if(!t)return a.innerHTML='<option value="">جميع الفئات</option>',void n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),a.appendChild(e)}});a.innerHTML='<option value="">جميع الفئات</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",a.appendChild(e)})};i.addEventListener("change",e=>{t(e.target.value),a&&(a.value=""),o("")})}const c=document.getElementById("reportMainCategory");if(c&&r){c.innerHTML='<option value="">اختر الفئة الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,c.appendChild(e)});const t=t=>{r.innerHTML='<option value="">اختر الفئة</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",r.appendChild(e)})};c.addEventListener("change",e=>{t(e.target.value)})}}catch(t){console.error("Error loading categories:",t)}}(),o();const t=document.getElementById("manualLocationGroup"),a=document.getElementById("reportAddress"),r=document.getElementById("reportLatManual"),i=document.getElementById("reportLngManual");function c(){a&&(document.getElementById("reportLatManual"),document.getElementById("reportLngManual"),a.required=!0)}document.getElementById("autoLocationGroup"),document.getElementById("locationModeTabs"),t&&(isAdmin&&isAdmin()?t.classList.remove("hidden"):t.classList.add("hidden")),r&&r.addEventListener("input",c),i&&i.addEventListener("input",c),c();const l=document.getElementById("categoryFilter");l&&l.addEventListener("change",t=>{o(t.target.value)});const s=document.getElementById("refreshBtn");s&&s.addEventListener("click",n(async()=>{await d(!1)},800,!0));const u=document.getElementById("refreshDailyBtn");u&&u.addEventListener("click",n(async()=>{await d(!1)},800,!0));const g=document.getElementById("reportForm");g&&g.addEventListener("submit",async t=>{if(t.preventDefault(),!isPublisher())return void showNotification("يجب أن تكون ناشراً لإنشاء تقرير","error");const e=document.getElementById("reportLat"),n=document.getElementById("reportLng");document.getElementById("reportLatManual"),document.getElementById("reportLngManual");const a={latitude:e?e.value:"",longitude:n?n.value:"",category:document.getElementById("reportCategory").value,report_address:document.getElementById("reportAddress").value,is_manual_location:!1},r=await async function(t){try{const e=await fetchWithAuth(`${window.API_URL}/reports`,{method:"POST",body:JSON.stringify(t)}),n=await e.json();return e.ok?{success:!0,data:n}:{success:!1,error:n.error}}catch(t){return{success:!1,error:t.message}}}(a);r.success?(showNotification("تم إنشاء التقرير بنجاح","success"),document.getElementById("reportModal").classList.remove("active"),g.reset(),o()):showNotification(r.error||"حدث خطأ في إنشاء التقرير","error")});const m=document.getElementById("cancelBtn");function p(){const t=new Date,e=new Date(t);e.setHours(24,0,0,0);const n=e.getTime()-t.getTime();setTimeout(async()=>{await d(!0),p()},n)}m&&m.addEventListener("click",()=>{document.getElementById("reportModal").classList.remove("active")}),document.querySelectorAll(".close, .close-details").forEach(t=>{t.addEventListener("click",function(){this.closest(".modal").classList.remove("active")})}),window.addEventListener("click",t=>{const e=document.getElementById("reportModal"),n=document.getElementById("detailsModal");t.target===e&&e.classList.remove("active"),t.target===n&&n.classList.remove("active")}),document.addEventListener("DOMContentLoaded",()=>{p()})});const s=n(async()=>{const t=latManualElInit?latManualElInit.value:"",e=lngManualElInit?lngManualElInit.value:"";if(!t||!e)return;const n=l(t,!1),o=l(e,!0);if(null==n||null==o)return;const a=document.getElementById("reportLat"),i=document.getElementById("reportLng");a&&(a.value=n),i&&(i.value=o);try{const t=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${n}&lon=${o}&accept-language=ar`),e=await t.json();if(e&&e.address){const t=e.address.country_code;if(t&&"lb"!==t.toLowerCase())return void(window.showNotification&&window.showNotification("يمكن تحديد مواقع داخل لبنان فقط","error"))}const a=e&&e.address?e.address:{};let i=a.city||a.town||a.village||a.hamlet||a.municipality||a.county||"";i||(i=r(e&&e.display_name?e.display_name:`${n.toFixed(6)}, ${o.toFixed(6)}`)),addressInput&&(addressInput.value=i||`${n.toFixed(6)}, ${o.toFixed(6)}`)}catch(t){}},600,!0);if(latManualElInit&&latManualElInit.addEventListener("input",()=>{syncAddressRequirement(),"manual"===locationMode&&s()}),lngManualElInit&&lngManualElInit.addEventListener("input",()=>{syncAddressRequirement(),"manual"===locationMode&&s()}),tabs){const t=tabs.querySelector('[data-mode="auto"]'),e=tabs.querySelector('[data-mode="manual"]'),n=n=>{if(!("manual"!==n||isAdmin&&isAdmin()))return void(window.showNotification&&window.showNotification("الوضع اليدوي للمدراء فقط","error"));locationMode=n,t&&t.classList.toggle("active","auto"===n),e&&e.classList.toggle("active","manual"===n),autoGroup&&(autoGroup.style.display="auto"===n?"":"none"),manualGroup&&(manualGroup.style.display="manual"===n?"":"none");const o=document.getElementById("searchAddressBtn"),a=document.getElementById("reportLatManual"),r=document.getElementById("reportLngManual"),i=isAdmin&&isAdmin();addressInput&&(addressInput.readOnly="manual"===n,addressInput.placeholder="manual"===n?"اسم المدينة (يُحدد تلقائياً)":"ابحث عن موقع أو أدخل العنوان يدوياً",addressInput.required="auto"===n),o&&(o.style.display="manual"===n?"none":"",o.disabled="manual"===n),a&&(a.required="manual"===n&&i),r&&(r.required="manual"===n&&i),syncAddressRequirement(),"manual"===n&&s()};t&&t.addEventListener("click",()=>n("auto")),e&&e.addEventListener("click",()=>n("manual")),!e||isAdmin&&isAdmin()||(e.disabled=!0,e.title="للمدراء فقط"),n("auto")}})();