(()=>{let t=[],e=[];function n(t,e=500,n=!0){let o;return function(){const r=this,i=arguments,a=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||t.apply(r,i)},e),a&&t.apply(r,i)}}async function o(e=""){try{let n=`${window.API_URL}/reports/today`;e&&(n+=`?category=${e}`);const o=await fetch(n);if(!o.ok){const t=await o.json().catch(()=>({}));throw new Error(t.error||"فشل تحميل التقارير")}const r=await o.json();if(t=Array.isArray(r)?r:[],window.updateMapMarkers)try{window.updateMapMarkers(t)}catch(t){window.showNotification&&window.showNotification("حدث خطأ في عرض العلامات","error")}const c=document.getElementById("dailyDate");return a(c?c.value:i(new Date)),t}catch(t){return console.error("Error loading reports:",t),navigator.onLine?window.showNotification&&window.showNotification(t.message||"فشل تحميل التقارير","error"):window.showNotification&&window.showNotification("لا يوجد اتصال بالشبكة","error"),[]}}function r(t){const n=e.find(e=>e.catg_id==t);return n?n.catg_name:"غير معروف"}function i(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function a(e){const n=document.querySelector("#dailyReportsTable tbody");n&&(n.innerHTML="",t.filter(t=>i(new Date(t.date_and_time))===e).forEach(t=>{const e=document.createElement("tr"),o=new Date(t.date_and_time).toLocaleTimeString("ar-LB",{hour:"2-digit",minute:"2-digit"}),i=t.category_name||r(t.categorie),a=function(t){if(!t)return"";const e=t.split(",");return e[0]?e[0].trim():t}(t.report_address);e.innerHTML=`<td>${o}</td><td><span style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>                <circle cx="12" cy="9" r="2" fill="currentColor"></circle>            </svg> ${i}</span></td><td>${a}</td>`,n.appendChild(e)}))}async function c(t){const e=document.getElementById("categoryFilter"),n=e?e.value:"",r=document.getElementById("refreshBtn"),i=document.getElementById("refreshDailyBtn");if(window.setMapLoading&&window.setMapLoading(!0),r){r.disabled=!0;const t=r.innerHTML;r.dataset.prev=t,r.innerHTML='<span class="loading" style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <circle cx="12" cy="12" r="10" opacity="0.2"></circle>                <path d="M12 2a10 10 0 0 1 10 10" />            </svg>            جاري التحديث...        </span>'}i&&(i.disabled=!0);try{window.clearMarkers&&window.clearMarkers(),await o(n),window.showNotification&&window.showNotification(t?"تم تحديث تقارير اليوم لليوم الجديد":"تم تحديث تقارير اليوم","info")}catch(t){window.showNotification&&window.showNotification("حدث خطأ أثناء التحديث","error")}finally{r&&(r.disabled=!1,r.dataset.prev&&(r.innerHTML=r.dataset.prev)),i&&(i.disabled=!1),window.setMapLoading&&window.setMapLoading(!1)}}window.showReportDetails=function(t){const e=document.getElementById("detailsModal"),n=document.getElementById("reportDetails");if(!e||!n)return;const o=new Date(t.date_and_time).toLocaleDateString("ar-LB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),i=t.category_name||r(t.categorie),a=`rgb(${t.category_color_r||100}, ${t.category_color_g||100}, ${t.category_color_b||100})`;n.innerHTML=`\n        <div class="report-detail">\n            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">\n                <div style="\n                    background-color: ${a};\n                    width: 48px;\n                    height: 48px;\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 28px;\n                    border: 3px solid white;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n                ">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n                        <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>\n                        <circle cx="12" cy="9" r="2" fill="white"></circle>\n                    </svg>\n                </div>\n                <h3 style="margin: 0; color: ${a};">${i}</h3>\n            </div>\n            <p><strong>الموقع:</strong> ${t.report_address}</p>\n            <p><strong>التاريخ والوقت:</strong> ${o}</p>\n            <p><strong>الإحداثيات:</strong> ${t.latitude.toFixed(6)}, ${t.longitude.toFixed(6)}</p>\n            ${t.reporter_name?`<p><strong>المبلغ:</strong> ${t.reporter_name}</p>`:""}\n        </div>\n    `,e.classList.add("active")},document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("dailyDate");if(t){const e=i(new Date);t.value=e,t.addEventListener("change",()=>a(t.value)),a(e)}}),document.addEventListener("DOMContentLoaded",()=>{!async function(){try{const t=await fetch(`${window.API_URL}/categories`),n=await t.json();e=n;const r=document.getElementById("categoryFilter"),i=document.getElementById("reportCategory");r&&(r.innerHTML='<option value="">جميع الفئات</option>',n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),r.appendChild(e)}}));const a=document.getElementById("mainCategoryFilter");if(a){a.innerHTML='<option value="">جميع الفئات الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,a.appendChild(e)});const t=t=>{if(!r)return;if(!t)return r.innerHTML='<option value="">جميع الفئات</option>',void n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),r.appendChild(e)}});r.innerHTML='<option value="">جميع الفئات</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",r.appendChild(e)})};a.addEventListener("change",e=>{t(e.target.value),r&&(r.value=""),o("")})}const c=document.getElementById("reportMainCategory");if(c&&i){c.innerHTML='<option value="">اختر الفئة الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,c.appendChild(e)});const t=t=>{i.innerHTML='<option value="">اختر الفئة</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",i.appendChild(e)})};c.addEventListener("change",e=>{t(e.target.value)})}}catch(t){console.error("Error loading categories:",t)}}(),o();const t=document.getElementById("manualLocationGroup");t&&(isAdmin&&isAdmin()?t.classList.remove("hidden"):t.classList.add("hidden"));const r=document.getElementById("categoryFilter");r&&r.addEventListener("change",t=>{o(t.target.value)});const i=document.getElementById("refreshBtn");i&&i.addEventListener("click",n(async()=>{await c(!1)},800,!0));const a=document.getElementById("refreshDailyBtn");a&&a.addEventListener("click",n(async()=>{await c(!1)},800,!0));const d=document.getElementById("reportForm");d&&d.addEventListener("submit",async t=>{if(t.preventDefault(),!isPublisher())return void showNotification("يجب أن تكون ناشراً لإنشاء تقرير","error");const e=document.getElementById("reportLat"),n=document.getElementById("reportLng"),r=document.getElementById("reportLatManual"),i=document.getElementById("reportLngManual");let a=e?e.value:"",c=n?n.value:"",s=!1;if(isAdmin&&isAdmin()&&r&&i&&r.value&&i.value){const t=parseFloat(r.value),e=parseFloat(i.value);if(isNaN(t)||isNaN(e)||t<-90||t>90||e<-180||e>180)return void showNotification("إحداثيات غير صالحة","error");a=t,c=e,s=!0}const l={latitude:a,longitude:c,category:document.getElementById("reportCategory").value,report_address:document.getElementById("reportAddress").value,is_manual_location:s},g=await async function(t){try{const e=await fetchWithAuth(`${window.API_URL}/reports`,{method:"POST",body:JSON.stringify(t)}),n=await e.json();return e.ok?{success:!0,data:n}:{success:!1,error:n.error}}catch(t){return{success:!1,error:t.message}}}(l);g.success?(showNotification("تم إنشاء التقرير بنجاح","success"),document.getElementById("reportModal").classList.remove("active"),d.reset(),o()):showNotification(g.error||"حدث خطأ في إنشاء التقرير","error")});const s=document.getElementById("cancelBtn");function l(){const t=new Date,e=new Date(t);e.setHours(24,0,0,0);const n=e.getTime()-t.getTime();setTimeout(async()=>{await c(!0),l()},n)}s&&s.addEventListener("click",()=>{document.getElementById("reportModal").classList.remove("active")}),document.querySelectorAll(".close, .close-details").forEach(t=>{t.addEventListener("click",function(){this.closest(".modal").classList.remove("active")})}),window.addEventListener("click",t=>{const e=document.getElementById("reportModal"),n=document.getElementById("detailsModal");t.target===e&&e.classList.remove("active"),t.target===n&&n.classList.remove("active")}),document.addEventListener("DOMContentLoaded",()=>{l()})})})();