(()=>{let t=[],e=[];function n(t,e=500,n=!0){let o;return function(){const a=this,i=arguments,r=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||t.apply(a,i)},e),r&&t.apply(a,i)}}async function o(e=""){try{let n=`${window.API_URL}/reports/today`;e&&(n+=`?category=${e}`);const o=await fetch(n);if(!o.ok){const t=await o.json().catch(()=>({}));throw new Error(t.error||"فشل تحميل التقارير")}const a=await o.json();if(t=Array.isArray(a)?a:[],window.updateMapMarkers)try{window.updateMapMarkers(t)}catch(t){window.showNotification&&window.showNotification("حدث خطأ في عرض العلامات","error")}const i=document.getElementById("dailyDate");return d(i?i.value:r(new Date)),t}catch(t){return console.error("Error loading reports:",t),navigator.onLine?window.showNotification&&window.showNotification(t.message||"فشل تحميل التقارير","error"):window.showNotification&&window.showNotification("لا يوجد اتصال بالشبكة","error"),[]}}function a(t){const n=e.find(e=>e.catg_id==t);return n?n.catg_name:"غير معروف"}function i(t){if(!t)return"";const e=t.split(",");return e[0]?e[0].trim():t}function r(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function d(e){const n=document.querySelector("#dailyReportsTable tbody");n&&(n.innerHTML="",t.filter(t=>r(new Date(t.date_and_time))===e).forEach(t=>{const e=document.createElement("tr"),o=new Date(t.date_and_time).toLocaleTimeString("ar-LB",{hour:"2-digit",minute:"2-digit"}),r=t.category_name||a(t.categorie),d=i(t.report_address);e.innerHTML=`<td>${o}</td><td><span style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>                <circle cx="12" cy="9" r="2" fill="currentColor"></circle>            </svg> ${r}</span></td><td>${d}</td>`,n.appendChild(e)}))}async function c(t){const e=document.getElementById("categoryFilter"),n=e?e.value:"",a=document.getElementById("refreshBtn"),i=document.getElementById("refreshDailyBtn");if(window.setMapLoading&&window.setMapLoading(!0),a){a.disabled=!0;const t=a.innerHTML;a.dataset.prev=t,a.innerHTML='<span class="loading" style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <circle cx="12" cy="12" r="10" opacity="0.2"></circle>                <path d="M12 2a10 10 0 0 1 10 10" />            </svg>            جاري التحديث...        </span>'}i&&(i.disabled=!0);try{window.clearMarkers&&window.clearMarkers(),await o(n),window.showNotification&&window.showNotification(t?"تم تحديث تقارير اليوم لليوم الجديد":"تم تحديث تقارير اليوم","info")}catch(t){window.showNotification&&window.showNotification("حدث خطأ أثناء التحديث","error")}finally{a&&(a.disabled=!1,a.dataset.prev&&(a.innerHTML=a.dataset.prev)),i&&(i.disabled=!1),window.setMapLoading&&window.setMapLoading(!1)}}function l(t,e){if(!t)return null;const n=String(t).trim().replace(/\s+/g," ");let o=1;const a=n.match(/[NSEW]/i);if(a){const t=a[0].toUpperCase();"S"!==t&&"W"!==t||(o=-1)}const i=n.replace(/°/g," ").replace(/'/g," ").replace(/"/g," ").trim().split(" ").filter(Boolean);let r=0,d=0,c=0;if(1===i.length){const t=parseFloat(i[0]);return isNaN(t)?null:t*o}if(2===i.length){if(r=parseFloat(i[0]),d=parseFloat(i[1]),isNaN(r)||isNaN(d))return null}else if(r=parseFloat(i[0]),d=parseFloat(i[1]),c=parseFloat(i[2]),isNaN(r)||isNaN(d)||isNaN(c))return null;const l=(Math.abs(r)+Math.abs(d)/60+Math.abs(c)/3600)*(r<0?-1:1)*o;return e&&Math.abs(l)>180||!e&&Math.abs(l)>90?null:l}window.showReportDetails=function(t){const e=document.getElementById("detailsModal"),n=document.getElementById("reportDetails");if(!e||!n)return;const o=new Date(t.date_and_time).toLocaleDateString("ar-LB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),i=t.category_name||a(t.categorie),r=`rgb(${t.category_color_r||100}, ${t.category_color_g||100}, ${t.category_color_b||100})`,d="number"==typeof t.latitude?t.latitude:parseFloat(t.latitude),c="number"==typeof t.longitude?t.longitude:parseFloat(t.longitude),l=isNaN(d)||isNaN(c)?"غير متوفر":`${d.toFixed(6)}, ${c.toFixed(6)}`;n.innerHTML=`\n        <div class="report-detail">\n            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">\n                <div style="\n                    background-color: ${r};\n                    width: 48px;\n                    height: 48px;\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 28px;\n                    border: 3px solid white;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n                ">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n                        <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>\n                        <circle cx="12" cy="9" r="2" fill="white"></circle>\n                    </svg>\n                </div>\n                <h3 style="margin: 0; color: ${r};">${i}</h3>\n            </div>\n            <p><strong>الموقع:</strong> ${t.report_address}</p>\n            <p><strong>التاريخ والوقت:</strong> ${o}</p>\n            <p><strong>الإحداثيات:</strong> ${l}</p>\n            ${t.reporter_name?`<p><strong>المبلغ:</strong> ${t.reporter_name}</p>`:""}\n        </div>\n    `,e.classList.add("active")},document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("dailyDate");if(t){const e=r(new Date);t.value=e,t.addEventListener("change",()=>d(t.value)),d(e)}}),document.addEventListener("DOMContentLoaded",()=>{!async function(){try{const t=await fetch(`${window.API_URL}/categories`),n=await t.json();e=n;const a=document.getElementById("categoryFilter"),i=document.getElementById("reportCategory");a&&(a.innerHTML='<option value="">جميع الفئات</option>',n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),a.appendChild(e)}}));const r=document.getElementById("mainCategoryFilter");if(r){r.innerHTML='<option value="">جميع الفئات الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,r.appendChild(e)});const t=t=>{if(!a)return;if(!t)return a.innerHTML='<option value="">جميع الفئات</option>',void n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),a.appendChild(e)}});a.innerHTML='<option value="">جميع الفئات</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",a.appendChild(e)})};r.addEventListener("change",e=>{t(e.target.value),a&&(a.value=""),o("")})}const d=document.getElementById("reportMainCategory");if(d&&i){d.innerHTML='<option value="">اختر الفئة الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,d.appendChild(e)});const t=t=>{i.innerHTML='<option value="">اختر الفئة</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",i.appendChild(e)})};d.addEventListener("change",e=>{t(e.target.value)})}}catch(t){console.error("Error loading categories:",t)}}(),o(),document.getElementById("manualLocationGroup");const t=document.getElementById("reportAddress"),a=document.getElementById("reportLatManual"),i=document.getElementById("reportLngManual");function r(){t&&(document.getElementById("reportLatManual"),document.getElementById("reportLngManual"),t.required=!0)}document.getElementById("autoLocationGroup"),document.getElementById("locationModeTabs"),a&&a.addEventListener("input",r),i&&i.addEventListener("input",r),r();const d=document.getElementById("categoryFilter");d&&d.addEventListener("change",t=>{o(t.target.value)});const l=document.getElementById("refreshBtn");l&&l.addEventListener("click",n(async()=>{await c(!1)},800,!0));const s=document.getElementById("refreshDailyBtn");s&&s.addEventListener("click",n(async()=>{await c(!1)},800,!0));const u=document.getElementById("reportForm");u&&u.addEventListener("submit",async t=>{if(t.preventDefault(),!window.isPublisher||!window.isPublisher())return void(window.showNotification&&window.showNotification("يجب أن تكون ناشراً لإنشاء تقرير","error"));const e=document.getElementById("reportLat"),n=document.getElementById("reportLng");document.getElementById("reportLatManual"),document.getElementById("reportLngManual");const a={latitude:e?e.value:"",longitude:n?n.value:"",category:document.getElementById("reportCategory").value,report_address:document.getElementById("reportAddress").value,is_manual_location:!1},i=await async function(t){try{const e=await window.fetchWithAuth(`${window.API_URL}/reports`,{method:"POST",body:JSON.stringify(t)}),n=await e.json();return e.ok?{success:!0,data:n}:{success:!1,error:n.error}}catch(t){return{success:!1,error:t.message}}}(a);i.success?(window.showNotification&&window.showNotification("تم إنشاء التقرير بنجاح","success"),document.getElementById("reportModal").classList.remove("active"),u.reset(),o()):window.showNotification&&window.showNotification(i.error||"حدث خطأ في إنشاء التقرير","error")});const g=document.getElementById("cancelBtn");function m(){const t=new Date,e=new Date(t);e.setHours(24,0,0,0);const n=e.getTime()-t.getTime();setTimeout(async()=>{await c(!0),m()},n)}g&&g.addEventListener("click",()=>{document.getElementById("reportModal").classList.remove("active")}),document.querySelectorAll(".close, .close-details").forEach(t=>{t.addEventListener("click",function(){this.closest(".modal").classList.remove("active")})}),window.addEventListener("click",t=>{const e=document.getElementById("reportModal"),n=document.getElementById("detailsModal");t.target===e&&e.classList.remove("active"),t.target===n&&n.classList.remove("active")}),document.addEventListener("DOMContentLoaded",()=>{m()})});const s=n(async()=>{const t=document.getElementById("reportLatManual"),e=document.getElementById("reportLngManual"),n=document.getElementById("reportAddress"),o=t?t.value:"",a=e?e.value:"";if(!o||!a)return;const r=l(o,!1),d=l(a,!0);if(null==r||null==d)return;const c=document.getElementById("reportLat"),s=document.getElementById("reportLng");c&&(c.value=r),s&&(s.value=d);try{const t=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${d}&accept-language=ar`),e=await t.json();if(e&&e.address){const t=e.address.country_code;if(t&&"lb"!==t.toLowerCase())return void(window.showNotification&&window.showNotification("يمكن تحديد مواقع داخل لبنان فقط","error"))}const o=e&&e.address?e.address:{};let a=o.city||o.town||o.village||o.hamlet||o.municipality||o.county||"";a||(a=i(e&&e.display_name?e.display_name:`${r.toFixed(6)}, ${d.toFixed(6)}`)),n&&(n.value=a||`${r.toFixed(6)}, ${d.toFixed(6)}`)}catch(t){}},600,!0);if(latManualElInit&&latManualElInit.addEventListener("input",()=>{syncAddressRequirement(),"manual"===locationMode&&s()}),lngManualElInit&&lngManualElInit.addEventListener("input",()=>{syncAddressRequirement(),"manual"===locationMode&&s()}),tabs){const t=tabs.querySelector('[data-mode="auto"]'),e=tabs.querySelector('[data-mode="manual"]'),n=n=>{if(!("manual"!==n||window.isAdmin&&window.isAdmin()))return void(window.showNotification&&window.showNotification("الوضع اليدوي للمدراء فقط","error"));locationMode=n,t&&t.classList.toggle("active","auto"===n),e&&e.classList.toggle("active","manual"===n);const o=window.isAdmin&&window.isAdmin();autoGroup&&autoGroup.classList.toggle("hidden","auto"!==n),manualGroup&&manualGroup.classList.toggle("hidden",!("manual"===n&&o));const a=document.getElementById("searchAddressBtn"),r=document.getElementById("reportLatManual"),d=document.getElementById("reportLngManual");addressInput&&(addressInput.readOnly="manual"===n,addressInput.placeholder="manual"===n?"اسم المدينة (يُحدد تلقائياً)":"ابحث عن موقع أو أدخل العنوان يدوياً",addressInput.required="auto"===n,"manual"===n&&addressInput.value&&(addressInput.value=i(addressInput.value))),a&&(a.style.display="manual"===n?"none":"",a.disabled="manual"===n),r&&(r.required="manual"===n&&o),d&&(d.required="manual"===n&&o),syncAddressRequirement(),"manual"===n&&s()};t&&t.addEventListener("click",()=>n("auto")),e&&e.addEventListener("click",()=>n("manual")),tabs&&tabs.addEventListener("click",t=>{const e=t.target.closest("button[data-mode]");if(!e)return;const o=e.getAttribute("data-mode");n("manual"===o?"manual":"auto")}),!e||window.isAdmin&&window.isAdmin()||(e.disabled=!0,e.title="للمدراء فقط"),n("auto"),window.setReportLocationMode=n}})();