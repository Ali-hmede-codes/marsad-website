(()=>{let t=[],e=[],n="";function o(t,e=500,n=!0){let o;return function(){const a=this,i=arguments,r=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||t.apply(a,i)},e),r&&t.apply(a,i)}}async function a(e=""){try{let o=`${window.API_URL}/reports/today`;e&&(o+=`?category=${e}`);const a=await fetch(o);if(!a.ok){const t=await a.json().catch(()=>({}));throw new Error(t.error||"فشل تحميل التقارير")}const i=await a.json();if(t=Array.isArray(i)?i:[],window.updateMapMarkers)try{const e=n?t.filter(t=>r(t.report_address||"").toLowerCase().includes(n.toLowerCase())):t;window.updateMapMarkers(e)}catch(t){window.showNotification&&window.showNotification("حدث خطأ في عرض العلامات","error")}const c=document.getElementById("dailyDate");return l(c?c.value:d(new Date)),t}catch(t){return console.error("Error loading reports:",t),navigator.onLine?window.showNotification&&window.showNotification(t.message||"فشل تحميل التقارير","error"):window.showNotification&&window.showNotification("لا يوجد اتصال بالشبكة","error"),[]}}function i(t){const n=e.find(e=>e.catg_id==t);return n?n.catg_name:"غير معروف"}function r(t){if(!t)return"";const e=String(t).split(",").map(t=>t.trim()).filter(Boolean),n=[/\b(?:مستشفى|مشفى|طريق|شارع|أوتوستراد|جسر|نفق|مطار|جامعة|محطة|قصر|مرفأ|ميناء|دوار|مستديرة|مدرسة|سوق|مول|صيدلية|مطعم|فندق|معمل|مصنع)\b/u,/\b(?:pharmacy|pharmacie|hospital|hopital|clinic|clinique|shop|store|market|supermarket|mall|restaurant|hotel|bank|atm|station|bridge|tunnel|airport|university|school|college|center|centre)\b/i],o=t=>n.some(e=>e.test(t)),a=t=>/\d/.test(t),i=/(قضاء|محافظة|لبنان|lebanon|liban)/i,r=e.findIndex(t=>i.test(t)),c=r>0?e.slice(0,r).filter(t=>!o(t)&&!a(t)):e.filter(t=>!o(t)&&!a(t));if(!c.length)return e.find(t=>!o(t))||String(t).trim();const s=c.filter(t=>/[\u0600-\u06FF]/.test(t));return s.length?s[s.length-1]:c[c.length-1]}function c(t){const e=String(t||"").trim();return!!e&&(!/\d/.test(e)&&![/\b(?:مستشفى|مشفى|طريق|شارع|أوتوستراد|جسر|نفق|مطار|جامعة|محطة|قصر|مرفأ|ميناء|دوار|مستديرة|مدرسة|سوق|مول|صيدلية|مطعم|فندق|معمل|مصنع)\b/u,/\b(?:pharmacy|pharmacie|hospital|hopital|clinic|clinique|shop|store|market|supermarket|mall|restaurant|hotel|bank|atm|station|bridge|tunnel|airport|university|school|college|center|centre)\b/i,/\b(?:lebanon|liban|لبنان|محافظة|قضاء)\b/i].some(t=>t.test(e)))}function s(t){const e=t||{},n=e.city||e.town||e.village||e.hamlet||e.municipality||e.county||"";return String(n||"").trim()}function d(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function l(e){const o=document.querySelector("#dailyReportsTable tbody");o&&(o.innerHTML="",(n?t.filter(t=>r(t.report_address||"").toLowerCase().includes(n.toLowerCase())):t).filter(t=>d(new Date(t.date_and_time))===e).forEach(t=>{const e=document.createElement("tr"),n=new Date(t.date_and_time).toLocaleTimeString("ar-LB",{hour:"2-digit",minute:"2-digit"}),a=t.category_name||i(t.categorie),c=r(t.report_address),s=Number(t.confirmation_count||1);e.innerHTML=`<td>${n}</td><td><span style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>                <circle cx="12" cy="9" r="2" fill="currentColor"></circle>            </svg> ${a}</span></td><td>${c}</td><td><span class="badge" style="display:inline-block;padding:2px 8px;border-radius:12px;background:#eee;color:#333;font-weight:600;">${s}</span></td>`,o.appendChild(e)}))}async function u(t){const e=document.getElementById("categoryFilter"),n=e?e.value:"",o=document.getElementById("refreshBtn"),i=document.getElementById("refreshDailyBtn");if(window.setMapLoading&&window.setMapLoading(!0),o){o.disabled=!0;const t=o.innerHTML;o.dataset.prev=t,o.innerHTML='<span class="loading" style="display:inline-flex;align-items:center;gap:6px;">            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                <circle cx="12" cy="12" r="10" opacity="0.2"></circle>                <path d="M12 2a10 10 0 0 1 10 10" />            </svg>            جاري التحديث...        </span>'}i&&(i.disabled=!0);try{window.clearMarkers&&window.clearMarkers(),await a(n),window.showNotification&&window.showNotification(t?"تم تحديث تقارير اليوم لليوم الجديد":"تم تحديث تقارير اليوم","info")}catch(t){window.showNotification&&window.showNotification("حدث خطأ أثناء التحديث","error")}finally{o&&(o.disabled=!1,o.dataset.prev&&(o.innerHTML=o.dataset.prev)),i&&(i.disabled=!1),window.setMapLoading&&window.setMapLoading(!1)}}function m(t,e){if(!t)return null;const n=String(t).trim().replace(/\s+/g," ");let o=1;const a=n.match(/[NSEW]/i);if(a){const t=a[0].toUpperCase();"S"!==t&&"W"!==t||(o=-1)}const i=n.replace(/°/g," ").replace(/'/g," ").replace(/"/g," ").trim().split(" ").filter(Boolean);let r=0,c=0,s=0;if(1===i.length){const t=parseFloat(i[0]);return isNaN(t)?null:t*o}if(2===i.length){if(r=parseFloat(i[0]),c=parseFloat(i[1]),isNaN(r)||isNaN(c))return null}else if(r=parseFloat(i[0]),c=parseFloat(i[1]),s=parseFloat(i[2]),isNaN(r)||isNaN(c)||isNaN(s))return null;const d=(Math.abs(r)+Math.abs(c)/60+Math.abs(s)/3600)*(r<0?-1:1)*o;return e&&Math.abs(d)>180||!e&&Math.abs(d)>90?null:d}window.showReportDetails=function(t){const e=document.getElementById("detailsModal"),n=document.getElementById("reportDetails");if(!e||!n)return;const o=new Date(t.date_and_time).toLocaleDateString("ar-LB",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),a=t.category_name||i(t.categorie),c=`rgb(${t.category_color_r||100}, ${t.category_color_g||100}, ${t.category_color_b||100})`;n.innerHTML=`\n        <div class="report-detail">\n            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">\n                <div style="\n                    background-color: ${c};\n                    width: 48px;\n                    height: 48px;\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    font-size: 28px;\n                    border: 3px solid white;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n                ">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n                        <path d="M12 2c4 0 7 3 7 7 0 6-7 13-7 13s-7-7-7-13c0-4 3-7 7-7z"></path>\n                        <circle cx="12" cy="9" r="2" fill="white"></circle>\n                    </svg>\n                </div>\n                <h3 style="margin: 0; color: ${c};">${a}</h3>\n            </div>\n            <p><strong>الموقع:</strong> ${r(t.report_address)}</p>\n            <p><strong>التاريخ والوقت:</strong> ${o}</p>\n            <p><strong>الإحداثيات:</strong> ${t.latitude.toFixed(6)}, ${t.longitude.toFixed(6)}</p>\n            ${t.reporter_name?`<p><strong>المبلغ:</strong> ${t.reporter_name}</p>`:""}\n        </div>\n    `,e.classList.add("active")},window.extractCity=r,window.isValidCityName=c,document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("dailyDate");if(t){const e=d(new Date);t.value=e,t.addEventListener("change",()=>l(t.value)),l(e)}}),document.addEventListener("DOMContentLoaded",()=>{!async function(){try{const t=await fetch(`${window.API_URL}/categories`),n=await t.json();e=n;const o=document.getElementById("categoryFilter"),i=document.getElementById("reportCategory");o&&(o.innerHTML='<option value="">جميع الفئات</option>',n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),o.appendChild(e)}}));const r=document.getElementById("mainCategoryFilter");if(r){r.innerHTML='<option value="">جميع الفئات الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,r.appendChild(e)});const t=t=>{if(!o)return;if(!t)return o.innerHTML='<option value="">جميع الفئات</option>',void n.forEach(t=>{if(t.children&&t.children.length>0){const e=document.createElement("optgroup");e.label=t.catg_name,t.children.forEach(t=>{const n=document.createElement("option");n.value=t.catg_id;const o=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;n.textContent=t.catg_name,n.style.color=o,n.style.fontWeight="bold",e.appendChild(n)}),o.appendChild(e)}});o.innerHTML='<option value="">جميع الفئات</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",o.appendChild(e)})};r.addEventListener("change",e=>{t(e.target.value),o&&(o.value=""),a("")})}const c=document.getElementById("reportMainCategory");if(c&&i){c.innerHTML='<option value="">اختر الفئة الرئيسية</option>',n.forEach(t=>{const e=document.createElement("option");e.value=t.catg_id,e.textContent=t.catg_name,c.appendChild(e)});const t=t=>{i.innerHTML='<option value="">اختر الفئة</option>';const e=n.find(e=>String(e.catg_id)===String(t));(e&&e.children?e.children:[]).forEach(t=>{const e=document.createElement("option");e.value=t.catg_id;const n=`rgb(${t.catg_color_r||100}, ${t.catg_color_g||100}, ${t.catg_color_b||100})`;e.textContent=t.catg_name,e.style.color=n,e.style.fontWeight="bold",i.appendChild(e)})};c.addEventListener("change",e=>{t(e.target.value)})}}catch(t){console.error("Error loading categories:",t)}}(),a();const i=document.getElementById("manualLocationGroup"),g=document.getElementById("reportAddress"),p=document.getElementById("reportLatManual"),w=document.getElementById("reportLngManual"),y=document.getElementById("autoLocationGroup"),h=document.getElementById("locationModeTabs");let f="auto";function v(){if(!g)return;const t=document.getElementById("reportLatManual"),e=document.getElementById("reportLngManual"),n="manual"===f&&isAdmin&&isAdmin()&&t&&e&&t.value&&e.value;g.required=!n}const E=o(async()=>{const t=p?p.value:"",e=w?w.value:"";if(!t||!e)return;const n=m(t,!1),o=m(e,!0);if(null==n||null==o)return;const a=document.getElementById("reportLat"),i=document.getElementById("reportLng");a&&(a.value=n),i&&(i.value=o);try{const t=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${n}&lon=${o}&accept-language=ar`),e=await t.json();if(e&&e.address){const t=e.address.country_code;if(t&&"lb"!==t.toLowerCase())return void(window.showNotification&&window.showNotification("يمكن تحديد مواقع داخل لبنان فقط","error"))}let a=s(e&&e.address?e.address:{});a||(a=r(e&&e.display_name?e.display_name:`${n.toFixed(6)}, ${o.toFixed(6)}`)),g&&(g.value=a||`${n.toFixed(6)}, ${o.toFixed(6)}`)}catch(t){}},600,!0);p&&p.addEventListener("input",()=>{v(),"manual"===f&&E()}),w&&w.addEventListener("input",()=>{v(),"manual"===f&&E()}),v();const L=document.getElementById("categoryFilter");L&&L.addEventListener("change",t=>{a(t.target.value)});const _=document.getElementById("refreshBtn");_&&_.addEventListener("click",o(async()=>{await u(!1)},800,!0));const b=document.getElementById("locationSearch"),B=document.getElementById("searchBtn"),M=document.getElementById("locationSuggestions"),I=o(()=>{n=b?String(b.value||"").trim():"";const e=document.getElementById("dailyDate"),o=e?e.value:d(new Date);window.clearMarkers&&window.clearMarkers();try{const e=n?t.filter(t=>r(t.report_address||"").toLowerCase().includes(n.toLowerCase())):t;window.updateMapMarkers&&window.updateMapMarkers(e)}catch(t){}l(o),window.showNotification&&window.showNotification(n?`تمت التصفية حسب المدينة: ${n}`:"تم إلغاء التصفية حسب المدينة","info"),M&&(M.style.display="none")},300,!0);B&&B.addEventListener("click",I),b&&b.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),I())});const N=o(()=>async function(e){if(!M)return;const n=String(e||"").trim();if(!n||n.length<2)return M.style.display="none",void(M.innerHTML="");try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=lb&limit=10&accept-language=ar&q=${encodeURIComponent(n)}`),o=await e.json(),a=(Array.isArray(o)?o:[]).filter(t=>["city","town","village","hamlet","municipality"].includes(t.type)),i=[];a.forEach(t=>{const e=t.address||{};let n=e.city||e.town||e.village||e.hamlet||e.municipality||e.county||"";n||(n=r(t.display_name||"")),n=String(n||"").trim(),n&&!i.includes(n)&&i.push(n)});const c=new Set;t.forEach(t=>{const e=r(t.report_address||"");e&&e.toLowerCase().includes(n.toLowerCase())&&c.add(e)});const s=Array.from(new Set([...i,...Array.from(c)]));s.length?(M.innerHTML=s.slice(0,10).map(t=>`<button type="button" class="suggestion-item" data-city="${t}">${t}</button>`).join(""),M.style.display="block"):(M.innerHTML="",M.style.display="none")}catch(t){M.innerHTML="",M.style.display="none"}}(b?b.value:""),300,!0);async function $(t){const e="manual"===t?document.getElementById("gpsManualBtn"):document.getElementById("gpsAutoBtn");try{e&&(e.disabled=!0),window.setMapLoading&&window.setMapLoading(!0),window.showNotification&&window.showNotification("جارٍ تحديد موقعك...","info");const n=await async function(){return new Promise((t,e)=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(e=>t(e.coords),t=>e(t),{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}):e(new Error("المتصفح لا يدعم تحديد الموقع"))})}(),o=n.latitude,a=n.longitude,i=document.getElementById("reportLat"),c=document.getElementById("reportLng");if(i&&(i.value=o),c&&(c.value=a),"manual"===t&&p&&w)p.value=o.toFixed(6),w.value=a.toFixed(6),E();else try{const t=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${o}&lon=${a}&accept-language=ar`),e=await t.json();if(e&&e.address){const t=e.address.country_code;t&&"lb"!==t.toLowerCase()&&window.showNotification&&window.showNotification("يمكن تحديد مواقع داخل لبنان فقط","error")}let n=s(e&&e.address?e.address:{});n||(n=r(e&&e.display_name?e.display_name:`${o.toFixed(6)}, ${a.toFixed(6)}`)),g&&(g.value=n||`${o.toFixed(6)}, ${a.toFixed(6)}`)}catch(t){}window.showNotification&&window.showNotification("تم تحديد الموقع بنجاح","success")}catch(t){const e=t&&t.message?t.message:"تعذر تحديد موقعك";t&&1===t.code?window.showNotification&&window.showNotification("تم رفض الإذن للوصول إلى الموقع","error"):t&&2===t.code?window.showNotification&&window.showNotification("إشارة GPS ضعيفة أو غير متاحة","error"):t&&3===t.code?window.showNotification&&window.showNotification("انتهى الوقت دون استرجاع الموقع","error"):window.showNotification&&window.showNotification(e,"error")}finally{const e="manual"===t?document.getElementById("gpsManualBtn"):document.getElementById("gpsAutoBtn");e&&(e.disabled=!1),window.setMapLoading&&window.setMapLoading(!1)}}b&&(b.addEventListener("input",N),b.addEventListener("focus",N)),M&&M.addEventListener("click",t=>{const e=t.target.closest(".suggestion-item");e&&(b&&(b.value=e.dataset.city||""),I(),M.style.display="none")}),document.addEventListener("click",t=>{M&&(M.contains(t.target)||b&&b.contains&&b.contains(t.target)||(M.style.display="none"))});const x=document.getElementById("gpsAutoBtn");x&&x.addEventListener("click",()=>$("auto"));const k=document.getElementById("gpsManualBtn");k&&k.addEventListener("click",()=>$("manual"));const C=document.getElementById("refreshDailyBtn");C&&C.addEventListener("click",o(async()=>{await u(!1)},800,!0));const S=document.getElementById("reportForm");S&&S.addEventListener("submit",async t=>{if(t.preventDefault(),!isPublisher())return void showNotification("يجب أن تكون ناشراً لإنشاء تقرير","error");const e=document.getElementById("reportLat"),n=document.getElementById("reportLng"),o=document.getElementById("reportLatManual"),i=document.getElementById("reportLngManual");let s=e?e.value:"",d=n?n.value:"",l=!1;if("manual"===f&&isAdmin&&isAdmin()&&o&&i&&o.value&&i.value){const t=m(o.value,!1),e=m(i.value,!0);if(null==t||null==e)return void showNotification("صيغة الإحداثيات غير صحيحة","error");s=t,d=e,l=!0}const u=r(document.getElementById("reportAddress").value);if(!c(u))return void showNotification("يرجى اختيار مدينة أو بلدة فقط","error");const g={latitude:s,longitude:d,category:document.getElementById("reportCategory").value,report_address:u,is_manual_location:l},p=await async function(t){try{const e=await fetchWithAuth(`${window.API_URL}/reports`,{method:"POST",body:JSON.stringify(t)}),n=await e.json();return e.ok?{success:!0,data:n}:{success:!1,error:n.error}}catch(t){return{success:!1,error:t.message}}}(g);if(p.success){const t=p.data&&p.data.updated?"تم تحديث عدد مرات التبليغ":"تم إنشاء التقرير بنجاح";showNotification(t,"success"),document.getElementById("reportModal").classList.remove("active"),S.reset(),a()}else showNotification(p.error||"حدث خطأ في إنشاء التقرير","error")});const A=document.getElementById("cancelBtn");function F(){const t=new Date,e=new Date(t);e.setHours(24,0,0,0);const n=e.getTime()-t.getTime();setTimeout(async()=>{await u(!0),F()},n)}if(A&&A.addEventListener("click",()=>{document.getElementById("reportModal").classList.remove("active")}),document.querySelectorAll(".close, .close-details").forEach(t=>{t.addEventListener("click",function(){this.closest(".modal").classList.remove("active")})}),window.addEventListener("click",t=>{const e=document.getElementById("reportModal"),n=document.getElementById("detailsModal");t.target===e&&e.classList.remove("active"),t.target===n&&n.classList.remove("active")}),document.addEventListener("DOMContentLoaded",()=>{F()}),h){const t=h.querySelector('[data-mode="auto"]'),e=h.querySelector('[data-mode="manual"]'),n=n=>{if(!("manual"!==n||isAdmin&&isAdmin()))return void(window.showNotification&&window.showNotification("الوضع اليدوي للمدراء فقط","error"));f=n,t&&t.classList.toggle("active","auto"===n),e&&e.classList.toggle("active","manual"===n);const o=isAdmin&&isAdmin();y&&y.classList.toggle("hidden","auto"!==n),i&&i.classList.toggle("hidden",!("manual"===n&&o));const a=document.getElementById("searchAddressBtn"),c=document.getElementById("reportLatManual"),s=document.getElementById("reportLngManual");g&&(g.readOnly="manual"===n,g.placeholder="manual"===n?"اسم المدينة (يُحدد تلقائياً)":"ابحث عن موقع أو أدخل العنوان يدوياً",g.required="auto"===n,"manual"===n&&g.value&&(g.value=r(g.value))),a&&(a.style.display="manual"===n?"none":"",a.disabled="manual"===n),c&&(c.required="manual"===n&&o),s&&(s.required="manual"===n&&o),v(),"manual"===n&&E()};t&&t.addEventListener("click",()=>n("auto")),e&&e.addEventListener("click",()=>n("manual")),h&&h.addEventListener("click",t=>{const e=t.target.closest("button[data-mode]");if(!e)return;const o=e.getAttribute("data-mode");n("manual"===o?"manual":"auto")}),!e||isAdmin&&isAdmin()||(e.disabled=!0,e.title="للمدراء فقط"),n("auto"),window.setReportLocationMode=n}})})();