<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ø§Ù„Ù€Ù€Ø±Ø§Ø¯Ø§Ø±961">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ø§Ù„Ù€Ù€Ø±Ø§Ø¯Ø§Ø±961</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <span class="logo-icon" style="display:inline-flex;align-items:center;justify-content:center;width:60px;height:60px;overflow:hidden;">
                        <img src="assets/logo.png" alt="Ø§Ù„Ø±Ø§Ø¯Ø§Ø±961" style="width:100%;height:100%;object-fit:contain;" />
                    </span>
                </a>
                <nav class="nav">
                    <a href="/" class="btn btn-secondary btn-sm">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                    <button id="logoutBtn" class="btn btn-secondary btn-icon" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                        <img src="https://img.icons8.com/ios/50/exit--v1.png" alt="Logout" />
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
                <p class="dashboard-subtitle" id="adminSubtitle"></p>
            </div>

            

            <div class="button-group" style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                <button id="tabHome" class="btn btn-secondary">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button id="tabWhatsapp" class="btn btn-secondary">ÙˆØ§ØªØ³Ø§Ø¨</button>
                <button id="tabReports" class="btn btn-secondary">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                <button id="tabAccounts" class="btn btn-secondary">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
                <button id="tabCategories" class="btn btn-secondary">Ø§Ù„ÙØ¦Ø§Øª</button>
            </div>

            <section id="homeSection" class="card" style="padding: 0;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshHomeBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div class="stats-grid" style="padding: 16px 24px;">
                    <div class="stat-card">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div>
                        <div class="stat-value" id="homeTotalReports">0</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="homeTypesTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="homeCitiesTable" style="margin-top:12px;">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="whatsappSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">ÙˆØ§ØªØ³Ø§Ø¨</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshWhatsappBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                        <button id="showQrBtn" class="btn btn-primary btn-sm">Ø¹Ø±Ø¶ QR</button>
                        <button id="restartWhatsappBtn" class="btn btn-secondary btn-sm">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button id="clearAuthBtn" class="btn btn-secondary btn-sm" style="color: var(--color-error);">Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</button>
                    </div>
                </div>
                <div style="padding: 0 24px 16px;">
                    <div id="whatsappStatus" class="text-muted" style="margin-bottom:12px;"></div>
                    <div id="whatsappQrBox" style="display:none; align-items:center; justify-content:center; min-height:340px;">
                        <img id="whatsappQrImg" alt="WhatsApp QR" style="max-width:360px; display:block; border:1px solid var(--color-border); border-radius:8px;" />
                    </div>
                    <div class="form-group" style="margin-top: 12px; display:flex; align-items:center; gap:12px;">
                        <label style="margin:0;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="waSendToggle" class="toggle-input">
                            <label for="waSendToggle" class="toggle-label"></label>
                        </div>
                        <span id="waSendToggleStatus" class="text-muted"></span>
                    </div>
                </div>
                <div class="table-wrapper" style="margin-top:12px;">
                    <table class="table table-modern" id="whatsappChannelsTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù‚Ù†Ø§Ø©</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card" style="padding: 16px 24px; margin:12px 24px;">
                    <h3 class="section-title" style="margin:0 0 8px 0;">Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</h3>
                    <div class="form-group">
                        <label for="manualChannelsInput">Ø£Ø¯Ø®Ù„ Channel ID Ù„ÙƒÙ„ Ø³Ø·Ø±</label>
                        <textarea id="manualChannelsInput" class="form-control" rows="3" placeholder="Ù…Ø«Ø§Ù„: 12345@s.whatsapp.net"></textarea>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button id="saveManualChannelsBtn" class="btn btn-primary btn-sm">Ø­ÙØ¸ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</button>
                        <span id="manualChannelsStatus" class="text-muted"></span>
                    </div>
                    <div style="margin-top:12px;">
                        <div id="manualChannelsList" class="text-muted"></div>
                    </div>
                </div>
                <div class="card" style="padding: 16px 24px; margin:12px 24px;">
                    <h3 class="section-title" style="margin:0 0 8px 0;">Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                    <div class="form-group">
                        <label for="waDefaultTemplate">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label>
                        <textarea id="waDefaultTemplate" class="form-control" rows="2" placeholder="Ù…Ø«Ø§Ù„: ğŸ”´{name} ÙÙŠ Ù…Ù†Ø·Ù‚Ø© : {location}"></textarea>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button id="waSaveDefaultTemplateBtn" class="btn btn-primary btn-sm">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                        <span id="waDefaultTemplateStatus" class="text-muted"></span>
                    </div>
                    <hr style="margin:12px 0;">
                    <div class="form-group">
                        <label for="waTemplateCategorySelect">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©</label>
                        <select id="waTemplateCategorySelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="waCategoryTemplateInput">Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</label>
                        <textarea id="waCategoryTemplateInput" class="form-control" rows="2" placeholder="Ø§Ø³ØªØ®Ø¯Ù… {id} Ùˆ {name} Ùˆ {location}"></textarea>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <button id="waSaveCategoryTemplateBtn" class="btn btn-primary btn-sm">Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ¦Ø©</button>
                        <button id="waRemoveCategoryTemplateBtn" class="btn btn-secondary btn-sm" style="color: var(--color-error);">Ø­Ø°Ù Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ¦Ø©</button>
                        <span id="waCategoryTemplateStatus" class="text-muted"></span>
                    </div>
                    <div style="margin-top:12px;">
                        <div id="waTemplatesSummary" class="text-muted"></div>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshReportsBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="adminReportsTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="adminReportsBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="accountsSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshAccountsBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="adminUsersTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th>
                                <th>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="categoriesSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="addMainCategoryBtn" class="btn btn-primary btn-sm">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                        <button id="refreshCategoriesBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div id="categoriesContainer" class="categories-container">
                    <div class="text-center text-muted" style="padding: 2rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </section>

            <div id="categoryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</h2>
                        <button class="modal-close" id="categoryModalClose">&times;</button>
                    </div>
                    <form id="categoryForm" enctype="multipart/form-data">
                        <input type="hidden" id="categoryId" name="categoryId">
                        <input type="hidden" id="parentId" name="parentId">
                        <div class="form-group">
                            <label for="catg_name">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© *</label>
                            <input type="text" id="catg_name" name="catg_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="categorie_desc">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="categorie_desc" name="categorie_desc" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="catg_color">Ø§Ù„Ù„ÙˆÙ† *</label>
                            <div style="display:flex;gap:1rem;align-items:center;">
                                <input type="color" id="catg_color" name="catg_color" value="#000000" style="width:60px;height:40px;border:1px solid var(--color-border);border-radius:8px;cursor:pointer;">
                                <input type="text" id="catg_color_text" class="form-control" value="#000000" pattern="^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="catg_picture">ØµÙˆØ±Ø© Ø§Ù„ÙØ¦Ø©</label>
                            <input type="file" id="catg_picture" name="catg_picture" class="form-control" accept="image/*">
                            <div id="currentPicture" style="margin-top:0.5rem;"></div>
                        </div>
                        <div class="form-group">
                            <label for="required_role">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© *</label>
                            <select id="required_role" name="required_role" class="form-control" required>
                                <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="publisher">Ù†Ø§Ø´Ø±</option>
                                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="categoryModalCancel">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="js/dist/config.min.js"></script>
    <script src="js/dist/notifications.min.js"></script>
    <script src="js/dist/auth.min.js"></script>
    <script>
        (function(){
            fetch(API_URL + '/auth/me', { credentials: 'include' })
                .then(function(r){ if(!r.ok) throw new Error(); return r.json(); })
                .catch(function(){ window.location.href = '/login'; return; });
            document.getElementById('logoutBtn').addEventListener('click', logout);
            function showSection(id){
                var s1 = document.getElementById('homeSection');
                var s2 = document.getElementById('reportsSection');
                var s3 = document.getElementById('accountsSection');
                var s4 = document.getElementById('categoriesSection');
                var s5 = document.getElementById('whatsappSection');
                if(s1) s1.style.display = id==='home' ? '' : 'none';
                if(s2) s2.style.display = id==='reports' ? '' : 'none';
                if(s3) s3.style.display = id==='accounts' ? '' : 'none';
                if(s4) s4.style.display = id==='categories' ? '' : 'none';
                if(s5) s5.style.display = id==='whatsapp' ? '' : 'none';
            }
                    function loadHome(){
                Promise.all([
                    fetchWithAuth(API_URL + '/reports/today'),
                    fetchWithAuth(API_URL + '/reports/today/types'),
                    fetchWithAuth(API_URL + '/reports/today/cities')
                ]).then(function(arr){
                    return Promise.all(arr.map(function(r){ return r.ok ? r.json() : Promise.resolve([]); }));
                }).then(function(results){
                    var today = Array.isArray(results[0]) ? results[0] : [];
                    var types = Array.isArray(results[1]) ? results[1] : [];
                    var cities = Array.isArray(results[2]) ? results[2] : [];
                    var totalEl = document.getElementById('homeTotalReports');
                    if(totalEl) totalEl.textContent = today.length;
                    var tBody = document.querySelector('#homeTypesTable tbody');
                    if(tBody){
                        tBody.innerHTML = types.map(function(row){ return '<tr><td>'+ (row.category_name || row.category_id) +'</td><td>'+ row.count +'</td></tr>'; }).join('');
                        if(!types.length) tBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    }
                    var cBody = document.querySelector('#homeCitiesTable tbody');
                    if(cBody){
                        cBody.innerHTML = cities.map(function(row){ return '<tr><td>'+ (row.city || '') +'</td><td>'+ row.count +'</td></tr>'; }).join('');
                        if(!cities.length) cBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    }
                }).catch(function(){
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®Øµ', 'error');
                });
            }
            function extractCity(address){
                var s = String(address||'');
                var parts = s.split(',').map(function(p){return p.trim();}).filter(function(p){return !!p});
                var badA = /(Ù…Ø³ØªØ´ÙÙ‰|Ù…Ø´ÙÙ‰|Ø·Ø±ÙŠÙ‚|Ø´Ø§Ø±Ø¹|Ø£ÙˆØªÙˆØ³ØªØ±Ø§Ø¯|Ø¬Ø³Ø±|Ù†ÙÙ‚|Ù…Ø·Ø§Ø±|Ø¬Ø§Ù…Ø¹Ø©|Ù…Ø­Ø·Ø©|Ù‚ØµØ±|Ù…Ø±ÙØ£|Ù…ÙŠÙ†Ø§Ø¡|Ø¯ÙˆØ§Ø±|Ù…Ø³ØªØ¯ÙŠØ±Ø©|Ù…Ø¯Ø±Ø³Ø©|Ø³ÙˆÙ‚|Ù…ÙˆÙ„|ØµÙŠØ¯Ù„ÙŠØ©|Ù…Ø·Ø¹Ù…|ÙÙ†Ø¯Ù‚|Ù…Ø¹Ù…Ù„|Ù…ØµÙ†Ø¹|Ù„Ø¨Ù†Ø§Ù†|Ù…Ø­Ø§ÙØ¸Ø©|Ù‚Ø¶Ø§Ø¡)/i;
                var badE = /(pharmacy|pharmacie|hospital|hopital|clinic|clinique|shop|store|market|supermarket|mall|restaurant|hotel|bank|atm|station|bridge|tunnel|airport|university|school|college|center|centre|lebanon|liban)/i;
                var pool = parts.filter(function(p){ return !badA.test(p) && !badE.test(p) && !/\d/.test(p); });
                if(!pool.length) return s.trim();
                var arabicPool = pool.filter(function(p){ return /[\u0600-\u06FF]/.test(p); });
                return arabicPool.length ? arabicPool[arabicPool.length-1] : pool[pool.length-1];
            }
            function loadReports(){
                fetchWithAuth(API_URL + '/reports/today/full')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(rows){
                        var body = document.getElementById('adminReportsBody');
                        if(!body) return;
                        if(!rows.length){ body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</td></tr>'; return; }
                        body.innerHTML = rows.map(function(r){
                            var time = new Date(r.date_and_time).toLocaleTimeString('ar-LB', { hour: '2-digit', minute: '2-digit' });
                            var city = extractCity(r.report_address||'');
                            var name = r.reporter_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            return '<tr>'+
                                '<td>'+ time +'</td>'+
                                '<td>'+ (r.category_name||'') +'</td>'+
                                '<td>'+ city +'</td>'+
                                '<td>'+ (Number(r.confirmation_count||1)) +'</td>'+
                                '<td><button class="btn btn-secondary btn-sm" data-user="'+ r.reporter_id +'">'+ name +'</button></td>'+
                                '<td><button class="btn btn-secondary btn-sm" data-del="'+ r.rep_id +'" style="color: var(--color-error);">Ø­Ø°Ù</button></td>'+
                            '</tr>';
                        }).join('');
                    }).catch(function(){
                        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', 'error');
                    });
            }
            function deleteReport(id){
                fetchWithAuth(API_URL + '/reports/' + id, { method: 'DELETE' })
                    .then(function(r){ if(!r.ok) return r.json().then(function(e){throw new Error(e.error||'');}); return r.json(); })
                    .then(function(){ showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success'); loadReports(); loadHome(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error'); });
            }
            function loadUsers(){
                fetchWithAuth(API_URL + '/users')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(users){
                        var body = document.getElementById('adminUsersBody');
                        if(!body) return;
                        if(!users.length){ body.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</td></tr>'; return; }
                        body.innerHTML = users.map(function(u){
                            var status = u.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                            var roles = (u.is_admin ? 'Ù…Ø¯ÙŠØ±' : '') + (u.is_publisher ? (u.is_admin ? 'ØŒ ' : '') + 'Ù†Ø§Ø´Ø±' : (!u.is_admin ? 'Ù…Ø³ØªØ®Ø¯Ù…' : ''));
                            var created = new Date(u.created_at).toLocaleDateString('ar-LB');
                            return '<tr>'+
                                '<td>'+ (u.name||'') +'</td>'+
                                '<td>'+ (u.email||'') +'</td>'+
                                '<td>'+ status +'</td>'+
                                '<td>'+ roles +'</td>'+
                                '<td>'+ (u.reports_count||0) +'</td>'+
                                '<td>'+ created +'</td>'+
                                '<td>'+
                                    '<button class="btn btn-secondary btn-sm" data-toggle-active="'+ u.user_id +'">'+ (u.is_active ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„') +'</button> '+
                                    '<button class="btn btn-secondary btn-sm" data-toggle-pub="'+ u.user_id +'">'+ (u.is_publisher ? 'Ø¥Ø²Ø§Ù„Ø© Ù†Ø§Ø´Ø±' : 'Ø¬Ø¹Ù„Ù‡ Ù†Ø§Ø´Ø±') +'</button> '+
                                    '<button class="btn btn-secondary btn-sm" data-toggle-admin="'+ u.user_id +'">'+ (u.is_admin ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ø¯ÙŠØ±' : 'Ø¬Ø¹Ù„Ù‡ Ù…Ø¯ÙŠØ±') +'</button> '+
                                    '<button class="btn btn-secondary btn-sm" data-delete-user="'+ u.user_id +'" style="color: var(--color-error);">Ø­Ø°Ù</button>'+
                                '</td>'+
                            '</tr>';
                        }).join('');
                    }).catch(function(){
                        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'error');
                    });
            }
            function updateUser(userId, payload){
                fetchWithAuth(API_URL + '/users/' + userId + '/role', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                    .then(function(r){ if(!r.ok) return r.json().then(function(e){throw new Error(e.error||'');}); return r.json(); })
                    .then(function(){ showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨', 'success'); loadUsers(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨', 'error'); });
            }
            function deleteUser(userId){
                fetchWithAuth(API_URL + '/users/' + userId, { method: 'DELETE' })
                    .then(function(r){ if(!r.ok) return r.json().then(function(e){throw new Error(e.error||'');}); return r.json(); })
                    .then(function(){ showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success'); loadUsers(); })
                    .catch(function(e){ showNotification(e.message||'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error'); });
            }
            function wireEvents(){
                var homeBtn = document.getElementById('tabHome');
                var whatsappBtn = document.getElementById('tabWhatsapp');
                var reportsBtn = document.getElementById('tabReports');
                var accountsBtn = document.getElementById('tabAccounts');
                var categoriesBtn = document.getElementById('tabCategories');
                if(homeBtn) homeBtn.addEventListener('click', function(){ showSection('home'); });
                if(whatsappBtn) whatsappBtn.addEventListener('click', function(){ showSection('whatsapp'); loadWhatsapp(); });
                if(reportsBtn) reportsBtn.addEventListener('click', function(){ showSection('reports'); });
                if(accountsBtn) accountsBtn.addEventListener('click', function(){ showSection('accounts'); });
                if(categoriesBtn) categoriesBtn.addEventListener('click', function(){ showSection('categories'); });
                var refreshHomeBtn = document.getElementById('refreshHomeBtn');
                if(refreshHomeBtn) refreshHomeBtn.addEventListener('click', loadHome);
                var refreshReportsBtn = document.getElementById('refreshReportsBtn');
                if(refreshReportsBtn) refreshReportsBtn.addEventListener('click', loadReports);
                var refreshAccountsBtn = document.getElementById('refreshAccountsBtn');
                if(refreshAccountsBtn) refreshAccountsBtn.addEventListener('click', loadUsers);
                var refreshCategoriesBtn = document.getElementById('refreshCategoriesBtn');
                if(refreshCategoriesBtn) refreshCategoriesBtn.addEventListener('click', loadCategoriesAdmin);
                var addMainCategoryBtn = document.getElementById('addMainCategoryBtn');
                if(addMainCategoryBtn) addMainCategoryBtn.addEventListener('click', function(){ openCategoryModalAdmin(); });
                var reportsTable = document.getElementById('adminReportsTable');
                if(reportsTable){
                    reportsTable.addEventListener('click', function(e){
                        var t = e.target;
                        if(t && t.getAttribute('data-del')){ deleteReport(t.getAttribute('data-del')); }
                        if(t && t.getAttribute('data-user')){ showSection('accounts'); loadUsers(); }
                    });
                }
                var usersTable = document.getElementById('adminUsersTable');
                if(usersTable){
                    usersTable.addEventListener('click', function(e){
                        var t = e.target;
                        if(t && t.getAttribute('data-toggle-active')){ var id = t.getAttribute('data-toggle-active'); updateUser(id, { is_active: t.textContent==='ØªØ¹Ø·ÙŠÙ„' ? false : true }); }
                        if(t && t.getAttribute('data-toggle-pub')){ var id2 = t.getAttribute('data-toggle-pub'); updateUser(id2, { is_publisher: t.textContent.indexOf('Ø¬Ø¹Ù„Ù‡')>-1 ? true : false }); }
                        if(t && t.getAttribute('data-toggle-admin')){ var id3 = t.getAttribute('data-toggle-admin'); updateUser(id3, { is_admin: t.textContent.indexOf('Ø¬Ø¹Ù„Ù‡')>-1 ? true : false }); }
                        if(t && t.getAttribute('data-delete-user')){ var id4 = t.getAttribute('data-delete-user'); deleteUser(id4); }
                    });
                }
                var categoryModal = document.getElementById('categoryModal');
                var categoryModalClose = document.getElementById('categoryModalClose');
                var categoryModalCancel = document.getElementById('categoryModalCancel');
                if(categoryModalClose) categoryModalClose.addEventListener('click', closeCategoryModalAdmin);
                if(categoryModalCancel) categoryModalCancel.addEventListener('click', closeCategoryModalAdmin);
                var categoryForm = document.getElementById('categoryForm');
                if(categoryForm) categoryForm.addEventListener('submit', handleCategorySubmitAdmin);
                var colorPicker = document.getElementById('catg_color');
                var colorText = document.getElementById('catg_color_text');
                if(colorPicker && colorText){
                    colorPicker.addEventListener('input', function(){ colorText.value = colorPicker.value; });
                    colorText.addEventListener('input', function(){ var v = String(colorText.value||'').trim(); var m=/^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/; if(m.test(v)){ colorPicker.value = v.substring(0,7); }});
                }
            }

            var categoriesTree = [];
            var editingCategoryId = null;
            function loadCategoriesAdmin(){
                fetchWithAuth(API_URL + '/categories')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(data){ categoriesTree = data || []; displayCategoriesAdmin(); })
                    .catch(function(){ var c = document.getElementById('categoriesContainer'); if(c) c.innerHTML = '<div class="text-center" style="color: var(--color-error); padding: 2rem;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª</div>'; });
            }
            function displayCategoriesAdmin(){
                var container = document.getElementById('categoriesContainer');
                if(!container) return;
                if(!categoriesTree.length){ container.innerHTML = '<div class="text-center text-muted" style="padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©.</div>'; return; }
                container.innerHTML = categoriesTree.map(function(cat){ return renderCategoryAdmin(cat, 0); }).join('');
            }
            function renderCategoryAdmin(category, level){
                var indent = level * 2;
                var hasChildren = category.children && category.children.length>0;
                var roleText = { 'user':'Ù…Ø³ØªØ®Ø¯Ù…', 'publisher':'Ù†Ø§Ø´Ø±', 'admin':'Ù…Ø¯ÙŠØ±' };
                var html = '<div class="category-card" style="margin-right: '+indent+'rem;">'+
                    '<div class="category-header">'+
                    '<div class="category-info">'+
                    '<div class="category-color-badge" style="background-color: '+ (category.catg_color || '#000000') +'"></div>'+
                    '<div>'+
                    '<h3 class="category-name">'+ category.catg_name +'</h3>'+
                    (category.categorie_desc ? ('<p class="category-desc">'+ category.categorie_desc +'</p>') : '')+
                    '<div class="category-meta">'+
                    '<span class="category-role-badge">'+ (roleText[category.required_role] || category.required_role) +'</span>'+ (level===0 ? '<span class="category-type-badge">ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</span>' : '<span class="category-type-badge subcategory">ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©</span>')+
                    '</div>'+
                    '</div>'+
                    '</div>'+
                    (category.catg_picture ? ('<img src="'+ category.catg_picture +'" alt="'+ category.catg_name +'" class="category-picture">') : '')+
                    '</div>'+
                    '<div class="category-actions">'+ (level===0 ? ('<button class="btn btn-sm btn-secondary" data-add-sub="'+ category.catg_id +'">â• Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©</button>') : '')+
                    '<button class="btn btn-sm btn-secondary" data-edit="'+ category.catg_id +'">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>'+ ' '+
                    '<button class="btn btn-sm btn-secondary" data-delete="'+ category.catg_id +'" style="color: var(--color-error);">ğŸ—‘ï¸ Ø­Ø°Ù</button>'+ '</div>'+
                    '</div>';
                if(hasChildren){ html += category.children.map(function(ch){ return renderCategoryAdmin(ch, level+1); }).join(''); }
                return html;
            }
            function findCategoryByIdAdmin(id, list){
                var arr = list || categoriesTree;
                for(var i=0;i<arr.length;i++){ var c=arr[i]; if(String(c.catg_id)===String(id)) return c; if(c.children && c.children.length){ var f = findCategoryByIdAdmin(id, c.children); if(f) return f; } }
                return null;
            }
            function openCategoryModalAdmin(categoryId, parentId){
                editingCategoryId = categoryId || null;
                var modal = document.getElementById('categoryModal');
                var form = document.getElementById('categoryForm');
                var modalTitle = document.getElementById('modalTitle');
                if(!modal || !form || !modalTitle) return;
                form.reset();
                document.getElementById('categoryId').value = '';
                document.getElementById('parentId').value = '';
                var cp = document.getElementById('currentPicture'); if(cp) cp.innerHTML='';
                if(categoryId){
                    modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©';
                    var category = findCategoryByIdAdmin(categoryId);
                    if(!category) return;
                    document.getElementById('categoryId').value = category.catg_id;
                    document.getElementById('catg_name').value = category.catg_name;
                    document.getElementById('categorie_desc').value = category.categorie_desc || '';
                    document.getElementById('catg_color').value = (category.catg_color||'#000000').substring(0,7);
                    document.getElementById('catg_color_text').value = category.catg_color || '#000000';
                    document.getElementById('required_role').value = category.required_role;
                    if(category.catg_picture){ document.getElementById('currentPicture').innerHTML = '<img src="'+category.catg_picture+'" alt="Current" style="max-width:200px;border-radius:8px;">'; }
                } else if(parentId){
                    modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©';
                    document.getElementById('parentId').value = parentId;
                    var parent = findCategoryByIdAdmin(parentId);
                    if(parent){ document.getElementById('catg_color').value = (parent.catg_color||'#000000').substring(0,7); document.getElementById('catg_color_text').value = parent.catg_color||'#000000'; }
                } else {
                    modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©';
                    document.getElementById('catg_color').value = '#000000';
                    document.getElementById('catg_color_text').value = '#000000';
                }
                modal.classList.add('active');
            }
            function closeCategoryModalAdmin(){ var modal = document.getElementById('categoryModal'); if(modal) modal.classList.remove('active'); editingCategoryId=null; }
            function handleCategorySubmitAdmin(e){
                e.preventDefault();
                var formEl = e.target;
                var fdR = new FormData(formEl);
                var categoryId = fdR.get('categoryId');
                var parentId = fdR.get('parentId');
                var reqData = new FormData();
                reqData.append('catg_name', fdR.get('catg_name'));
                reqData.append('categorie_desc', fdR.get('categorie_desc'));
                var colorTxt = String(fdR.get('catg_color_text')||'').trim();
                var colorPick = String(fdR.get('catg_color')||'').trim();
                var rx = /^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/;
                var colorFinal = rx.test(colorTxt) ? colorTxt : (rx.test(colorPick) ? colorPick : '#000000');
                reqData.append('catg_color', colorFinal);
                reqData.append('required_role', fdR.get('required_role'));
                if(parentId) reqData.append('parent_id', parentId);
                var pictureFile = fdR.get('catg_picture'); if(pictureFile && pictureFile.size>0) reqData.append('catg_picture', pictureFile);
                var url, method;
                if(categoryId){ url = API_URL + '/categories/' + categoryId; method = 'PUT'; }
                else { url = API_URL + '/categories'; method = 'POST'; }
                fetchWithAuth(url, { method: method, body: reqData })
                    .then(function(r){ return r.ok ? r.json() : r.json().then(function(e){ throw new Error(e.error||''); }); })
                    .then(function(){ showNotification('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success'); closeCategoryModalAdmin(); loadCategoriesAdmin(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©', 'error'); });
            }
            function deleteCategoryAdmin(categoryId){
                fetchWithAuth(API_URL + '/categories/' + categoryId, { method:'DELETE' })
                    .then(function(r){ return r.ok ? r.json() : r.json().then(function(e){ throw new Error(e.error||''); }); })
                    .then(function(){ showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success'); loadCategoriesAdmin(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©', 'error'); });
            }
            document.addEventListener('click', function(e){
                var t = e.target;
                if(t && t.getAttribute('data-add-sub')){ openCategoryModalAdmin(null, t.getAttribute('data-add-sub')); }
                if(t && t.getAttribute('data-edit')){ openCategoryModalAdmin(t.getAttribute('data-edit')); }
                if(t && t.getAttribute('data-delete')){ deleteCategoryAdmin(t.getAttribute('data-delete')); }
            });
            fetchWithAuth(API_URL + '/admin/status')
                .then(function(resp){ if(resp.ok) return resp.json(); throw new Error('forbidden'); })
                .then(function(){
                    
                    fetchWithAuth(API_URL + '/auth/me')
                        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                        .then(function(user){ document.getElementById('adminSubtitle').textContent = user && user.name ? ('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + user.name) : ''; })
                        .catch(function(){});
                    wireEvents();
                    showSection('home');
                    loadHome();
                    loadReports();
                    loadUsers();
                    loadCategoriesAdmin();
                }).catch(function(){ showNotification('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ', 'error'); window.location.href = '/login'; });
        })();
    </script>
    <script>
        (function(){
            function loadWhatsapp(){
                fetchWithAuth(API_URL + '/whatsapp/status')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(st){
                        var el = document.getElementById('whatsappStatus');
                        if(el){
                            var t = 'Ù…ÙØ¹Ù‘Ù„: ' + (st.enabled ? 'Ù†Ø¹Ù…' : 'Ù„Ø§') + ' | Ø¥Ø±Ø³Ø§Ù„: ' + (st.sendEnabled ? 'Ù†Ø¹Ù…' : 'Ù„Ø§') + ' | Ù…ØµØ§Ø¯Ù‚: ' + (st.authenticated ? 'Ù†Ø¹Ù…' : 'Ù„Ø§') + ' | Ø¬Ø§Ù‡Ø²: ' + (st.ready ? 'Ù†Ø¹Ù…' : 'Ù„Ø§');
                            var extra = '';
                            if(st && st.error){
                                var err = String(st.error || '');
                                extra = ' | Ø®Ø·Ø£: ' + err;
                                if(/error while loading shared libraries|Failed to launch the browser process/i.test(err)){
                                    var hint = 'ØªØ­ØªØ§Ø¬ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¥Ù„Ù‰ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª ÙƒØ±ÙˆÙ…ÙŠÙˆÙ… (libatk, gtk, nss, asound ÙˆØºÙŠØ±Ù‡Ø§).';
                                    if(!st.chromePath){ hint += ' Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Chrome/Chromium ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….'; }
                                    extra += ' \u2014 ' + hint;
                                }
                            }
                            el.textContent = t + extra;
                        }
                        if(st && st.hasQr && !st.authenticated){ showWhatsappQR(); }
                    })
                    .catch(function(){ var el = document.getElementById('whatsappStatus'); if(el) el.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©'; });
                fetchWithAuth(API_URL + '/whatsapp/toggle')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(d){
                        var tgl = document.getElementById('waSendToggle');
                        var sEl = document.getElementById('waSendToggleStatus');
                        var enabled = !!(d && d.enabled);
                        if(tgl) tgl.checked = enabled;
                        if(sEl) sEl.textContent = enabled ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„';
                    })
                    .catch(function(){ var sEl = document.getElementById('waSendToggleStatus'); if(sEl) sEl.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©'; });
                fetchWithAuth(API_URL + '/whatsapp/channels/all')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(chs){
                        var body = document.querySelector('#whatsappChannelsTable tbody');
                        if(!body) return;
                        if(!chs || !chs.length){ body.innerHTML = '<tr><td class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª</td></tr>'; return; }
                        body.innerHTML = chs.map(function(c){ return '<tr><td>' + (c.name||c.id||'') + '</td></tr>'; }).join('');
                    })
                    .catch(function(){ var body = document.querySelector('#whatsappChannelsTable tbody'); if(body) body.innerHTML = '<tr><td class="text-center text-muted">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</td></tr>'; });
                fetchWithAuth(API_URL + '/whatsapp/channels/manual')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(ids){
                        var listEl = document.getElementById('manualChannelsList');
                        var inputEl = document.getElementById('manualChannelsInput');
                        if(Array.isArray(ids)){
                            if(listEl){ listEl.textContent = ids.length ? ('Ù‚Ù†ÙˆØ§Øª Ù…Ø­ÙÙˆØ¸Ø©: ' + ids.join(', ')) : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª ÙŠØ¯ÙˆÙŠØ©'; }
                            if(inputEl){ inputEl.value = ids.join('\n'); }
                        } else {
                            if(listEl){ listEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª ÙŠØ¯ÙˆÙŠØ©'; }
                        }
                    })
                    .catch(function(){ var listEl = document.getElementById('manualChannelsList'); if(listEl) listEl.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©'; });
                Promise.all([
                    fetchWithAuth(API_URL + '/whatsapp/templates'),
                    fetchWithAuth(API_URL + '/categories/children')
                ])
                    .then(function(arr){ return Promise.all(arr.map(function(r){ return r.ok ? r.json() : Promise.reject(); })); })
                    .then(function(res){
                        var templates = res[0] || {};
                        var children = Array.isArray(res[1]) ? res[1] : [];
                        var defaultEl = document.getElementById('waDefaultTemplate');
                        var selectEl = document.getElementById('waTemplateCategorySelect');
                        var inputEl = document.getElementById('waCategoryTemplateInput');
                        var summaryEl = document.getElementById('waTemplatesSummary');
                        if(defaultEl){ defaultEl.value = typeof templates.default === 'string' ? templates.default : 'ğŸ”´{name} ÙÙŠ Ù…Ù†Ø·Ù‚Ø© : {location}'; }
                        if(selectEl){
                            selectEl.innerHTML = children.map(function(c){ return '<option value="'+ c.catg_id +'">'+ (c.catg_name||c.catg_id) +'</option>'; }).join('');
                            var firstId = children[0] ? String(children[0].catg_id) : null;
                            var byId = templates.byId || {};
                            if(firstId && inputEl){ inputEl.value = byId[firstId] || ''; }
                        }
                        if(summaryEl){
                            var byIdCount = templates.byId ? Object.keys(templates.byId).length : 0;
                            var byNameCount = templates.byName ? Object.keys(templates.byName).length : 0;
                            summaryEl.textContent = 'Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: Ø¨Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ' + byIdCount + ' | Ø¨Ø§Ù„Ø§Ø³Ù… ' + byNameCount;
                        }
                    })
                    .catch(function(){ var summaryEl = document.getElementById('waTemplatesSummary'); if(summaryEl) summaryEl.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨'; });
            }
            function showWhatsappQR(){
                fetchWithAuth(API_URL + '/whatsapp/status')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(st){
                        if(st && st.hasQr){
                            return fetchWithAuth(API_URL + '/whatsapp/qr.png');
                        }
                        var box = document.getElementById('whatsappQrBox');
                        var img = document.getElementById('whatsappQrImg');
                        var status = document.getElementById('whatsappStatus');
                        if(box){ box.style.display = 'flex'; }
                        if(img){ img.src = ''; }
                        if(status){ status.textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² QR...'; }
                        return new Promise(function(resolve, reject){
                            var attempts = 0;
                            function poll(){
                                fetchWithAuth(API_URL + '/whatsapp/status')
                                    .then(function(rr){ return rr.ok ? rr.json() : Promise.reject(); })
                                    .then(function(s2){
                                        if(s2 && s2.hasQr){
                                            resolve(fetchWithAuth(API_URL + '/whatsapp/qr.png'));
                                        } else if(++attempts < 30){
                                            setTimeout(poll, 1500);
                                        } else {
                                            reject(new Error('no-qr'));
                                        }
                                    })
                                    .catch(function(){ if(++attempts < 30) setTimeout(poll, 1500); else reject(new Error('no-qr')); });
                            }
                            poll();
                        });
                    })
                    .then(function(r){
                        if(!r || !r.ok) throw new Error('fetch-qr');
                        return r.blob();
                    })
                    .then(function(b){
                        var url = URL.createObjectURL(b);
                        var img = document.getElementById('whatsappQrImg');
                        var box = document.getElementById('whatsappQrBox');
                        if(img) img.src = url;
                        if(box){ box.style.display = 'flex'; }
                    })
                    .catch(function(){
                        fetchWithAuth(API_URL + '/whatsapp/qr-data')
                            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                            .then(function(d){
                                var img = document.getElementById('whatsappQrImg');
                                var box = document.getElementById('whatsappQrBox');
                                if(img && d && d.dataUrl){ img.src = d.dataUrl; }
                                if(box){ box.style.display = 'flex'; }
                            })
                            .catch(function(){
                                fetchWithAuth(API_URL + '/whatsapp/qr.svg')
                                    .then(function(r){ return r.ok ? r.text() : Promise.reject(); })
                                    .then(function(svgText){
                                        var img = document.getElementById('whatsappQrImg');
                                        var box = document.getElementById('whatsappQrBox');
                                        var data = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgText);
                                        if(img) img.src = data;
                                        if(box){ box.style.display = 'flex'; }
                                    })
                                    .catch(function(){ showNotification('QR ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹', 'error'); });
                            });
                    });
            }
            window.loadWhatsapp = loadWhatsapp;
            window.showWhatsappQR = showWhatsappQR;
            function wireWhatsapp(){
                var btnR = document.getElementById('refreshWhatsappBtn');
                var btnQ = document.getElementById('showQrBtn');
                var btnRestart = document.getElementById('restartWhatsappBtn');
                var btnClear = document.getElementById('clearAuthBtn');
                if(btnR) btnR.addEventListener('click', loadWhatsapp);
                if(btnQ) btnQ.addEventListener('click', showWhatsappQR);
                if(btnRestart) btnRestart.addEventListener('click', function(){
                    fetchWithAuth(API_URL + '/whatsapp/restart', { method: 'POST' })
                        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                        .then(function(){ loadWhatsapp(); showWhatsappQR(); })
                        .catch(function(){ showNotification('ØªØ¹Ø°Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨', 'error'); });
                });
                if(btnClear) btnClear.addEventListener('click', function(){
                    fetchWithAuth(API_URL + '/whatsapp/auth/clear', { method: 'POST' })
                        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                        .then(function(){ loadWhatsapp(); showWhatsappQR(); })
                        .catch(function(){ showNotification('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error'); });
                });
                var toggleEl = document.getElementById('waSendToggle');
                var toggleStatusEl = document.getElementById('waSendToggleStatus');
                if(toggleEl){
                    toggleEl.addEventListener('change', function(){
                        var val = !!toggleEl.checked;
                        fetchWithAuth(API_URL + '/whatsapp/toggle', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: val }) })
                            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                            .then(function(d){ if(toggleStatusEl) toggleStatusEl.textContent = (d && d.enabled) ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„'; loadWhatsapp(); })
                            .catch(function(){ showNotification('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error'); });
                    });
                }
                var btnSaveManual = document.getElementById('saveManualChannelsBtn');
                if(btnSaveManual) btnSaveManual.addEventListener('click', function(){
                    var inputEl = document.getElementById('manualChannelsInput');
                    var statusEl = document.getElementById('manualChannelsStatus');
                    var ids = [];
                    if(inputEl){
                        ids = String(inputEl.value || '')
                            .split(/\r?\n|,/)
                            .map(function(s){ return s.trim(); })
                            .filter(function(s){ return !!s; });
                    }
                    fetchWithAuth(API_URL + '/whatsapp/channels/manual', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids: ids }) })
                        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                        .then(function(){ if(statusEl) statusEl.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸'; loadWhatsapp(); })
                        .catch(function(){ if(statusEl) statusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸'; });
                });
                var selectEl = document.getElementById('waTemplateCategorySelect');
                var catInputEl = document.getElementById('waCategoryTemplateInput');
                var defaultEl = document.getElementById('waDefaultTemplate');
                var saveDefaultBtn = document.getElementById('waSaveDefaultTemplateBtn');
                var saveCatBtn = document.getElementById('waSaveCategoryTemplateBtn');
                var removeCatBtn = document.getElementById('waRemoveCategoryTemplateBtn');
                var defaultStatusEl = document.getElementById('waDefaultTemplateStatus');
                var catStatusEl = document.getElementById('waCategoryTemplateStatus');
                if(selectEl){
                    selectEl.addEventListener('change', function(){
                        fetchWithAuth(API_URL + '/whatsapp/templates')
                            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                            .then(function(t){ var byId = t.byId || {}; var id = String(selectEl.value||''); if(catInputEl) catInputEl.value = byId[id] || ''; })
                            .catch(function(){ if(catInputEl) catInputEl.value = ''; });
                    });
                }
                if(saveDefaultBtn){
                    saveDefaultBtn.addEventListener('click', function(){
                        var val = defaultEl ? String(defaultEl.value||'') : '';
                        fetchWithAuth(API_URL + '/whatsapp/templates', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ default: val }) })
                            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                            .then(function(){ if(defaultStatusEl) defaultStatusEl.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸'; loadWhatsapp(); })
                            .catch(function(){ if(defaultStatusEl) defaultStatusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸'; });
                    });
                }
                if(saveCatBtn){
                    saveCatBtn.addEventListener('click', function(){
                        var id = String(selectEl ? selectEl.value : '');
                        var val = catInputEl ? String(catInputEl.value||'') : '';
                        var payload = { byId: {} }; payload.byId[id] = val;
                        fetchWithAuth(API_URL + '/whatsapp/templates', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                            .then(function(){ if(catStatusEl) catStatusEl.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸'; loadWhatsapp(); })
                            .catch(function(){ if(catStatusEl) catStatusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸'; });
                    });
                }
                if(removeCatBtn){
                    removeCatBtn.addEventListener('click', function(){
                        var id = String(selectEl ? selectEl.value : '');
                        fetchWithAuth(API_URL + '/whatsapp/templates', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ removeById: [id] }) })
                            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                            .then(function(){ if(catStatusEl) catStatusEl.textContent = 'ØªÙ… Ø§Ù„Ø­Ø°Ù'; loadWhatsapp(); })
                            .catch(function(){ if(catStatusEl) catStatusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'; });
                    });
                }
            }
            document.addEventListener('DOMContentLoaded', function(){ wireWhatsapp(); loadWhatsapp(); });
        })();
    </script>
</body>
</html>
