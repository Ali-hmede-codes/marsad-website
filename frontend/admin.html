<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ø§Ù„Ù€Ù€Ø±Ø§Ø¯Ø§Ø±961">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ø§Ù„Ù€Ù€Ø±Ø§Ø¯Ø§Ø±961</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <span class="logo-icon" style="display:inline-flex;align-items:center;justify-content:center;width:60px;height:60px;overflow:hidden;">
                        <img src="assets/logo.png" alt="Ø§Ù„Ø±Ø§Ø¯Ø§Ø±961" style="width:100%;height:100%;object-fit:contain;" />
                    </span>
                </a>
                <nav class="nav">
                    <a href="/" class="btn btn-secondary btn-sm">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                    <button id="logoutBtn" class="btn btn-secondary btn-icon" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                        <img src="https://img.icons8.com/ios/50/exit--v1.png" alt="Logout" />
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
                <p class="dashboard-subtitle" id="adminSubtitle"></p>
            </div>

            <div class="card" style="margin-bottom: 16px;">
                <div id="adminStatus" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</div>
            </div>

            <div class="button-group" style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                <button id="tabHome" class="btn btn-secondary">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button id="tabReports" class="btn btn-secondary">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                <button id="tabAccounts" class="btn btn-secondary">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
                <button id="tabCategories" class="btn btn-secondary">Ø§Ù„ÙØ¦Ø§Øª</button>
            </div>

            <section id="homeSection" class="card" style="padding: 0;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshHomeBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div class="stats-grid" style="padding: 16px 24px;">
                    <div class="stat-card">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div>
                        <div class="stat-value" id="homeTotalReports">0</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="homeTypesTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="homeCitiesTable" style="margin-top:12px;">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="reportsSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshReportsBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="adminReportsTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="adminReportsBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="accountsSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="refreshAccountsBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table table-modern" id="adminUsersTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th>
                                <th>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="categoriesSection" class="card" style="padding: 0; display:none;">
                <div class="daily-header" style="padding: 16px 24px;display:flex;align-items:center;justify-content:space-between;">
                    <h2 class="section-title" style="margin:0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h2>
                    <div class="daily-controls" style="display:flex;align-items:center;gap:12px;">
                        <button id="addMainCategoryBtn" class="btn btn-primary btn-sm">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                        <button id="refreshCategoriesBtn" class="btn btn-secondary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                </div>
                <div id="categoriesContainer" class="categories-container">
                    <div class="text-center text-muted" style="padding: 2rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </section>

            <div id="categoryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</h2>
                        <button class="modal-close" id="categoryModalClose">&times;</button>
                    </div>
                    <form id="categoryForm" enctype="multipart/form-data">
                        <input type="hidden" id="categoryId" name="categoryId">
                        <input type="hidden" id="parentId" name="parentId">
                        <div class="form-group">
                            <label for="catg_name">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© *</label>
                            <input type="text" id="catg_name" name="catg_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="categorie_desc">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="categorie_desc" name="categorie_desc" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="catg_color">Ø§Ù„Ù„ÙˆÙ† *</label>
                            <div style="display:flex;gap:1rem;align-items:center;">
                                <input type="color" id="catg_color" name="catg_color" value="#000000" style="width:60px;height:40px;border:1px solid var(--color-border);border-radius:8px;cursor:pointer;">
                                <input type="text" id="catg_color_text" class="form-control" value="#000000" pattern="^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="catg_picture">ØµÙˆØ±Ø© Ø§Ù„ÙØ¦Ø©</label>
                            <input type="file" id="catg_picture" name="catg_picture" class="form-control" accept="image/*">
                            <div id="currentPicture" style="margin-top:0.5rem;"></div>
                        </div>
                        <div class="form-group">
                            <label for="required_role">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© *</label>
                            <select id="required_role" name="required_role" class="form-control" required>
                                <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="publisher">Ù†Ø§Ø´Ø±</option>
                                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="categoryModalCancel">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="js/dist/config.min.js"></script>
    <script src="js/dist/notifications.min.js"></script>
    <script src="js/dist/auth.min.js"></script>
    <script>
        (function(){
            var token = typeof getToken==='function' ? getToken() : null;
            if(!token){
                window.location.href = '/login';
                return;
            }
            document.getElementById('logoutBtn').addEventListener('click', logout);
            function showSection(id){
                var s1 = document.getElementById('homeSection');
                var s2 = document.getElementById('reportsSection');
                var s3 = document.getElementById('accountsSection');
                var s4 = document.getElementById('categoriesSection');
                if(s1) s1.style.display = id==='home' ? '' : 'none';
                if(s2) s2.style.display = id==='reports' ? '' : 'none';
                if(s3) s3.style.display = id==='accounts' ? '' : 'none';
                if(s4) s4.style.display = id==='categories' ? '' : 'none';
            }
            function loadHome(){
                Promise.all([
                    fetchWithAuth(API_URL + '/reports/today'),
                    fetchWithAuth(API_URL + '/reports/today/types'),
                    fetchWithAuth(API_URL + '/reports/today/cities')
                ]).then(function(arr){
                    return Promise.all(arr.map(function(r){ return r.ok ? r.json() : Promise.resolve([]); }));
                }).then(function(results){
                    var today = Array.isArray(results[0]) ? results[0] : [];
                    var types = Array.isArray(results[1]) ? results[1] : [];
                    var cities = Array.isArray(results[2]) ? results[2] : [];
                    var totalEl = document.getElementById('homeTotalReports');
                    if(totalEl) totalEl.textContent = today.length;
                    var tBody = document.querySelector('#homeTypesTable tbody');
                    if(tBody){
                        tBody.innerHTML = types.map(function(row){ return '<tr><td>'+ (row.category_name || row.category_id) +'</td><td>'+ row.count +'</td></tr>'; }).join('');
                        if(!types.length) tBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    }
                    var cBody = document.querySelector('#homeCitiesTable tbody');
                    if(cBody){
                        cBody.innerHTML = cities.map(function(row){ return '<tr><td>'+ (row.city || '') +'</td><td>'+ row.count +'</td></tr>'; }).join('');
                        if(!cities.length) cBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    }
                }).catch(function(){
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®Øµ', 'error');
                });
            }
            function extractCity(address){
                var s = String(address||'');
                var parts = s.split(',').map(function(p){return p.trim();}).filter(function(p){return !!p});
                var badA = /(Ù…Ø³ØªØ´ÙÙ‰|Ù…Ø´ÙÙ‰|Ø·Ø±ÙŠÙ‚|Ø´Ø§Ø±Ø¹|Ø£ÙˆØªÙˆØ³ØªØ±Ø§Ø¯|Ø¬Ø³Ø±|Ù†ÙÙ‚|Ù…Ø·Ø§Ø±|Ø¬Ø§Ù…Ø¹Ø©|Ù…Ø­Ø·Ø©|Ù‚ØµØ±|Ù…Ø±ÙØ£|Ù…ÙŠÙ†Ø§Ø¡|Ø¯ÙˆØ§Ø±|Ù…Ø³ØªØ¯ÙŠØ±Ø©|Ù…Ø¯Ø±Ø³Ø©|Ø³ÙˆÙ‚|Ù…ÙˆÙ„|ØµÙŠØ¯Ù„ÙŠØ©|Ù…Ø·Ø¹Ù…|ÙÙ†Ø¯Ù‚|Ù…Ø¹Ù…Ù„|Ù…ØµÙ†Ø¹|Ù„Ø¨Ù†Ø§Ù†|Ù…Ø­Ø§ÙØ¸Ø©|Ù‚Ø¶Ø§Ø¡)/i;
                var badE = /(pharmacy|pharmacie|hospital|hopital|clinic|clinique|shop|store|market|supermarket|mall|restaurant|hotel|bank|atm|station|bridge|tunnel|airport|university|school|college|center|centre|lebanon|liban)/i;
                var pool = parts.filter(function(p){ return !badA.test(p) && !badE.test(p) && !/\d/.test(p); });
                if(!pool.length) return s.trim();
                var arabicPool = pool.filter(function(p){ return /[\u0600-\u06FF]/.test(p); });
                return arabicPool.length ? arabicPool[arabicPool.length-1] : pool[pool.length-1];
            }
            function loadReports(){
                fetchWithAuth(API_URL + '/reports/today/full')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(rows){
                        var body = document.getElementById('adminReportsBody');
                        if(!body) return;
                        if(!rows.length){ body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</td></tr>'; return; }
                        body.innerHTML = rows.map(function(r){
                            var time = new Date(r.date_and_time).toLocaleTimeString('ar-LB', { hour: '2-digit', minute: '2-digit' });
                            var city = extractCity(r.report_address||'');
                            var name = r.reporter_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            return '<tr>'+
                                '<td>'+ time +'</td>'+
                                '<td>'+ (r.category_name||'') +'</td>'+
                                '<td>'+ city +'</td>'+
                                '<td>'+ (Number(r.confirmation_count||1)) +'</td>'+
                                '<td><button class="btn btn-secondary btn-sm" data-user="'+ r.reporter_id +'">'+ name +'</button></td>'+
                                '<td><button class="btn btn-secondary btn-sm" data-del="'+ r.rep_id +'" style="color: var(--color-error);">Ø­Ø°Ù</button></td>'+
                            '</tr>';
                        }).join('');
                    }).catch(function(){
                        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', 'error');
                    });
            }
            function deleteReport(id){
                fetchWithAuth(API_URL + '/reports/' + id, { method: 'DELETE' })
                    .then(function(r){ if(!r.ok) return r.json().then(function(e){throw new Error(e.error||'');}); return r.json(); })
                    .then(function(){ showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success'); loadReports(); loadHome(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error'); });
            }
            function loadUsers(){
                fetchWithAuth(API_URL + '/users')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(users){
                        var body = document.getElementById('adminUsersBody');
                        if(!body) return;
                        if(!users.length){ body.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</td></tr>'; return; }
                        body.innerHTML = users.map(function(u){
                            var status = u.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                            var roles = (u.is_admin ? 'Ù…Ø¯ÙŠØ±' : '') + (u.is_publisher ? (u.is_admin ? 'ØŒ ' : '') + 'Ù†Ø§Ø´Ø±' : (!u.is_admin ? 'Ù…Ø³ØªØ®Ø¯Ù…' : ''));
                            var created = new Date(u.created_at).toLocaleDateString('ar-LB');
                            return '<tr>'+
                                '<td>'+ (u.name||'') +'</td>'+
                                '<td>'+ (u.email||'') +'</td>'+
                                '<td>'+ status +'</td>'+
                                '<td>'+ roles +'</td>'+
                                '<td>'+ (u.reports_count||0) +'</td>'+
                                '<td>'+ created +'</td>'+
                                '<td>'+
                                    '<button class="btn btn-secondary btn-sm" data-toggle-active="'+ u.user_id +'">'+ (u.is_active ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„') +'</button> '+
                                    '<button class="btn btn-secondary btn-sm" data-toggle-pub="'+ u.user_id +'">'+ (u.is_publisher ? 'Ø¥Ø²Ø§Ù„Ø© Ù†Ø§Ø´Ø±' : 'Ø¬Ø¹Ù„Ù‡ Ù†Ø§Ø´Ø±') +'</button> '+
                                    '<button class="btn btn-secondary btn-sm" data-toggle-admin="'+ u.user_id +'">'+ (u.is_admin ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ø¯ÙŠØ±' : 'Ø¬Ø¹Ù„Ù‡ Ù…Ø¯ÙŠØ±') +'</button> '+
                                    '<button class="btn btn-secondary btn-sm" data-delete-user="'+ u.user_id +'" style="color: var(--color-error);">Ø­Ø°Ù</button>'+
                                '</td>'+
                            '</tr>';
                        }).join('');
                    }).catch(function(){
                        showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª', 'error');
                    });
            }
            function updateUser(userId, payload){
                fetchWithAuth(API_URL + '/users/' + userId + '/role', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                    .then(function(r){ if(!r.ok) return r.json().then(function(e){throw new Error(e.error||'');}); return r.json(); })
                    .then(function(){ showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨', 'success'); loadUsers(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨', 'error'); });
            }
            function deleteUser(userId){
                fetchWithAuth(API_URL + '/users/' + userId, { method: 'DELETE' })
                    .then(function(r){ if(!r.ok) return r.json().then(function(e){throw new Error(e.error||'');}); return r.json(); })
                    .then(function(){ showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success'); loadUsers(); })
                    .catch(function(e){ showNotification(e.message||'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error'); });
            }
            function wireEvents(){
                var homeBtn = document.getElementById('tabHome');
                var reportsBtn = document.getElementById('tabReports');
                var accountsBtn = document.getElementById('tabAccounts');
                var categoriesBtn = document.getElementById('tabCategories');
                if(homeBtn) homeBtn.addEventListener('click', function(){ showSection('home'); });
                if(reportsBtn) reportsBtn.addEventListener('click', function(){ showSection('reports'); });
                if(accountsBtn) accountsBtn.addEventListener('click', function(){ showSection('accounts'); });
                if(categoriesBtn) categoriesBtn.addEventListener('click', function(){ showSection('categories'); });
                var refreshHomeBtn = document.getElementById('refreshHomeBtn');
                if(refreshHomeBtn) refreshHomeBtn.addEventListener('click', loadHome);
                var refreshReportsBtn = document.getElementById('refreshReportsBtn');
                if(refreshReportsBtn) refreshReportsBtn.addEventListener('click', loadReports);
                var refreshAccountsBtn = document.getElementById('refreshAccountsBtn');
                if(refreshAccountsBtn) refreshAccountsBtn.addEventListener('click', loadUsers);
                var refreshCategoriesBtn = document.getElementById('refreshCategoriesBtn');
                if(refreshCategoriesBtn) refreshCategoriesBtn.addEventListener('click', loadCategoriesAdmin);
                var addMainCategoryBtn = document.getElementById('addMainCategoryBtn');
                if(addMainCategoryBtn) addMainCategoryBtn.addEventListener('click', function(){ openCategoryModalAdmin(); });
                var reportsTable = document.getElementById('adminReportsTable');
                if(reportsTable){
                    reportsTable.addEventListener('click', function(e){
                        var t = e.target;
                        if(t && t.getAttribute('data-del')){ deleteReport(t.getAttribute('data-del')); }
                        if(t && t.getAttribute('data-user')){ showSection('accounts'); loadUsers(); }
                    });
                }
                var usersTable = document.getElementById('adminUsersTable');
                if(usersTable){
                    usersTable.addEventListener('click', function(e){
                        var t = e.target;
                        if(t && t.getAttribute('data-toggle-active')){ var id = t.getAttribute('data-toggle-active'); updateUser(id, { is_active: t.textContent==='ØªØ¹Ø·ÙŠÙ„' ? false : true }); }
                        if(t && t.getAttribute('data-toggle-pub')){ var id2 = t.getAttribute('data-toggle-pub'); updateUser(id2, { is_publisher: t.textContent.indexOf('Ø¬Ø¹Ù„Ù‡')>-1 ? true : false }); }
                        if(t && t.getAttribute('data-toggle-admin')){ var id3 = t.getAttribute('data-toggle-admin'); updateUser(id3, { is_admin: t.textContent.indexOf('Ø¬Ø¹Ù„Ù‡')>-1 ? true : false }); }
                        if(t && t.getAttribute('data-delete-user')){ var id4 = t.getAttribute('data-delete-user'); deleteUser(id4); }
                    });
                }
                var categoryModal = document.getElementById('categoryModal');
                var categoryModalClose = document.getElementById('categoryModalClose');
                var categoryModalCancel = document.getElementById('categoryModalCancel');
                if(categoryModalClose) categoryModalClose.addEventListener('click', closeCategoryModalAdmin);
                if(categoryModalCancel) categoryModalCancel.addEventListener('click', closeCategoryModalAdmin);
                var categoryForm = document.getElementById('categoryForm');
                if(categoryForm) categoryForm.addEventListener('submit', handleCategorySubmitAdmin);
            }

            var categoriesTree = [];
            var editingCategoryId = null;
            function loadCategoriesAdmin(){
                fetchWithAuth(API_URL + '/categories')
                    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                    .then(function(data){ categoriesTree = data || []; displayCategoriesAdmin(); })
                    .catch(function(){ var c = document.getElementById('categoriesContainer'); if(c) c.innerHTML = '<div class="text-center" style="color: var(--color-error); padding: 2rem;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª</div>'; });
            }
            function displayCategoriesAdmin(){
                var container = document.getElementById('categoriesContainer');
                if(!container) return;
                if(!categoriesTree.length){ container.innerHTML = '<div class="text-center text-muted" style="padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©.</div>'; return; }
                container.innerHTML = categoriesTree.map(function(cat){ return renderCategoryAdmin(cat, 0); }).join('');
            }
            function renderCategoryAdmin(category, level){
                var indent = level * 2;
                var hasChildren = category.children && category.children.length>0;
                var roleText = { 'user':'Ù…Ø³ØªØ®Ø¯Ù…', 'publisher':'Ù†Ø§Ø´Ø±', 'admin':'Ù…Ø¯ÙŠØ±' };
                var html = '<div class="category-card" style="margin-right: '+indent+'rem;">'+
                    '<div class="category-header">'+
                    '<div class="category-info">'+
                    '<div class="category-color-badge" style="background-color: '+ (category.catg_color || '#000000') +'"></div>'+
                    '<div>'+
                    '<h3 class="category-name">'+ category.catg_name +'</h3>'+
                    (category.categorie_desc ? ('<p class="category-desc">'+ category.categorie_desc +'</p>') : '')+
                    '<div class="category-meta">'+
                    '<span class="category-role-badge">'+ (roleText[category.required_role] || category.required_role) +'</span>'+ (level===0 ? '<span class="category-type-badge">ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</span>' : '<span class="category-type-badge subcategory">ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©</span>')+
                    '</div>'+
                    '</div>'+
                    '</div>'+
                    (category.catg_picture ? ('<img src="'+ category.catg_picture +'" alt="'+ category.catg_name +'" class="category-picture">') : '')+
                    '</div>'+
                    '<div class="category-actions">'+ (level===0 ? ('<button class="btn btn-sm btn-secondary" data-add-sub="'+ category.catg_id +'">â• Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©</button>') : '')+
                    '<button class="btn btn-sm btn-secondary" data-edit="'+ category.catg_id +'">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>'+ ' '+
                    '<button class="btn btn-sm btn-secondary" data-delete="'+ category.catg_id +'" style="color: var(--color-error);">ğŸ—‘ï¸ Ø­Ø°Ù</button>'+ '</div>'+
                    '</div>';
                if(hasChildren){ html += category.children.map(function(ch){ return renderCategoryAdmin(ch, level+1); }).join(''); }
                return html;
            }
            function findCategoryByIdAdmin(id, list){
                var arr = list || categoriesTree;
                for(var i=0;i<arr.length;i++){ var c=arr[i]; if(String(c.catg_id)===String(id)) return c; if(c.children && c.children.length){ var f = findCategoryByIdAdmin(id, c.children); if(f) return f; } }
                return null;
            }
            function openCategoryModalAdmin(categoryId, parentId){
                editingCategoryId = categoryId || null;
                var modal = document.getElementById('categoryModal');
                var form = document.getElementById('categoryForm');
                var modalTitle = document.getElementById('modalTitle');
                if(!modal || !form || !modalTitle) return;
                form.reset();
                document.getElementById('categoryId').value = '';
                document.getElementById('parentId').value = '';
                var cp = document.getElementById('currentPicture'); if(cp) cp.innerHTML='';
                if(categoryId){
                    modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©';
                    var category = findCategoryByIdAdmin(categoryId);
                    if(!category) return;
                    document.getElementById('categoryId').value = category.catg_id;
                    document.getElementById('catg_name').value = category.catg_name;
                    document.getElementById('categorie_desc').value = category.categorie_desc || '';
                    document.getElementById('catg_color').value = (category.catg_color||'#000000').substring(0,7);
                    document.getElementById('catg_color_text').value = category.catg_color || '#000000';
                    document.getElementById('required_role').value = category.required_role;
                    if(category.catg_picture){ document.getElementById('currentPicture').innerHTML = '<img src="'+category.catg_picture+'" alt="Current" style="max-width:200px;border-radius:8px;">'; }
                } else if(parentId){
                    modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©';
                    document.getElementById('parentId').value = parentId;
                    var parent = findCategoryByIdAdmin(parentId);
                    if(parent){ document.getElementById('catg_color').value = (parent.catg_color||'#000000').substring(0,7); document.getElementById('catg_color_text').value = parent.catg_color||'#000000'; }
                } else {
                    modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©';
                    document.getElementById('catg_color').value = '#000000';
                    document.getElementById('catg_color_text').value = '#000000';
                }
                modal.classList.add('active');
            }
            function closeCategoryModalAdmin(){ var modal = document.getElementById('categoryModal'); if(modal) modal.classList.remove('active'); editingCategoryId=null; }
            function handleCategorySubmitAdmin(e){
                e.preventDefault();
                var formEl = e.target;
                var fdR = new FormData(formEl);
                var categoryId = fdR.get('categoryId');
                var parentId = fdR.get('parentId');
                var reqData = new FormData();
                reqData.append('catg_name', fdR.get('catg_name'));
                reqData.append('categorie_desc', fdR.get('categorie_desc'));
                reqData.append('catg_color', fdR.get('catg_color_text'));
                reqData.append('required_role', fdR.get('required_role'));
                if(parentId) reqData.append('parent_id', parentId);
                var pictureFile = fdR.get('catg_picture'); if(pictureFile && pictureFile.size>0) reqData.append('catg_picture', pictureFile);
                var url, method;
                if(categoryId){ url = API_URL + '/categories/' + categoryId; method = 'PUT'; }
                else { url = API_URL + '/categories'; method = 'POST'; }
                fetchWithAuth(url, { method: method, body: reqData })
                    .then(function(r){ return r.ok ? r.json() : r.json().then(function(e){ throw new Error(e.error||''); }); })
                    .then(function(){ showNotification('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success'); closeCategoryModalAdmin(); loadCategoriesAdmin(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©', 'error'); });
            }
            function deleteCategoryAdmin(categoryId){
                fetchWithAuth(API_URL + '/categories/' + categoryId, { method:'DELETE' })
                    .then(function(r){ return r.ok ? r.json() : r.json().then(function(e){ throw new Error(e.error||''); }); })
                    .then(function(){ showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success'); loadCategoriesAdmin(); })
                    .catch(function(e){ showNotification(e.message||'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©', 'error'); });
            }
            document.addEventListener('click', function(e){
                var t = e.target;
                if(t && t.getAttribute('data-add-sub')){ openCategoryModalAdmin(t.getAttribute('data-add-sub')); }
                if(t && t.getAttribute('data-edit')){ openCategoryModalAdmin(t.getAttribute('data-edit')); }
                if(t && t.getAttribute('data-delete')){ deleteCategoryAdmin(t.getAttribute('data-delete')); }
            });
            fetchWithAuth(API_URL + '/admin/status')
                .then(function(resp){ if(resp.ok) return resp.json(); throw new Error('forbidden'); })
                .then(function(){
                    document.getElementById('adminStatus').textContent = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±';
                    fetchWithAuth(API_URL + '/auth/me')
                        .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
                        .then(function(user){ document.getElementById('adminSubtitle').textContent = user && user.name ? ('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + user.name) : ''; })
                        .catch(function(){});
                    wireEvents();
                    showSection('home');
                    loadHome();
                    loadReports();
                    loadUsers();
                    loadCategoriesAdmin();
                })
                .catch(function(){ showNotification('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ', 'error'); window.location.href = '/login'; });
        })();
    </script>
</body>
</html>
